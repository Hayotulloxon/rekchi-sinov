<!doctype html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RekchiAi olmoslari</title>
    <script src="https://telegram.org/js/telegram-web-app.js?t=<?php echo time(); ?>"></script>
    
    <!-- KESHNI BUTUNLAY BLOKLASH -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body style="background:black; color:white; text-align:center; padding:50px 20px;">
    
    <!-- STOP xabari -->
    <div id="stop-message" style="display:none;">
        <h1 style="font-size:32px; color:red; margin-bottom:20px;">â›”</h1>
        <h2 style="font-size:24px; margin-bottom:10px;">Mini appdan chiqib kiring</h2>
        <p style="margin-bottom:30px; opacity:0.8;">Dastur vaqtincha yopildi</p>
        
        <button onclick="closeApp()" 
                style="padding:15px 30px; background:#0088cc; color:white; border:none; border-radius:10px; font-size:16px;">
            Chiqish
        </button>
    </div>
    
    <!-- Asosiy app -->
    <div id="main-app">
        <!-- SIZNING ASOSIY APP KODINGIZ -->
        <h1>RekchiAi ishlayapti...</h1>
    </div>

<script>
// GITHUBDAN STOP STATUSNI O'QISH (KESH OLMASLIK UCHUN)
async function checkStopStatus() {
    try {
        // HAR SAFAR YANGI URL (TIMESTAMP QO'SHAMIZ)
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        const url = `https://yourgithub.github.io/stop.json?t=${timestamp}&r=${random}&v=${VERSION}`;
        
        console.log("GitHubdan so'rov yuborildi:", url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            cache: 'no-store'
        });
        
        const data = await response.json();
        console.log("GitHub javobi:", data);
        
        return data.stop === true;
        
    } catch (error) {
        console.error("Xatolik:", error);
        return false;
    }
}

// TELEGRAM APP YOPISH
function closeApp() {
    if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.close();
    }
}

// ASOSIY DASTUR
async function main() {
    console.log("Dastur ishga tushdi");
    
    // 1. GitHubdan tekshiramiz
    const isStopped = await checkStopStatus();
    
    if (isStopped) {
        // STOP holatda
        document.getElementById('stop-message').style.display = 'block';
        document.getElementById('main-app').style.display = 'none';
        
        // 5 SONIYADA BIR TEKSHIRISH
        setInterval(async () => {
            const stillStopped = await checkStopStatus();
            if (!stillStopped) {
                location.reload(); // stop=false bo'lsa yangilash
            }
        }, 5000);
        
    } else {
        // NORMAL holatda
        document.getElementById('stop-message').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        
        // 30 SONIYADA BIR TEKSHIRISH
        setInterval(async () => {
            const isStoppedNow = await checkStopStatus();
            if (isStoppedNow) {
                location.reload(); // stop=true bo'lsa yangilash
            }
        }, 30000);
        
        // SIZNING ASOSIY APP LOGIKANGIZ
        console.log("Asosiy app ishga tushdi");
    }
}

// VERSIYA - HAR HTML YANGILANGANDA O'ZGARSIN
const VERSION = "2024.01.15.001"; // BU HAR YANGI VERSIYADA O'ZGARSIN!

// LOCALSTORAGE'DAGI VERSIYANI TEKSHIRISH
const savedVersion = localStorage.getItem('app_version');
if (savedVersion !== VERSION) {
    console.log("Yangi versiya:", VERSION);
    localStorage.clear();
    sessionStorage.clear();
    localStorage.setItem('app_version', VERSION);
    
    // INDEXEDDB NI HAM TOZALASH
    if (window.indexedDB) {
        indexedDB.databases().then(dbs => {
            dbs.forEach(db => {
                indexedDB.deleteDatabase(db.name);
            });
        });
    }
    
    // SERVICE WORKER NI TOZALASH
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => {
            regs.forEach(reg => reg.unregister());
        });
    }
    
    // COOKIE LARNI TOZALASH
    document.cookie.split(";").forEach(c => {
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });
}

// BRAUZER KESHINI TOZALASH FUNKSIYASI
function clearAllCaches() {
    // SERVICE WORKER
    if ('serviceWorker' in navigator) {
        caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
        });
    }
    
    // APPLICATION CACHE
    if (window.applicationCache) {
        window.applicationCache.update();
    }
}

// SAHIFA YUKLANGANDA
window.addEventListener('load', function() {
    // KESHNI TOZALASH
    clearAllCaches();
    
    // ASOSIY DASTURNI ISHGA TUSHIRISH
    main();
});

// ONLINE/OFFLINE TEKSHIRISH
window.addEventListener('online', function() {
    console.log("Online bo'ldi, tekshiramiz...");
    main();
});

// HAR 60 SONIYADA BRAUZER KESHINI TEKSHIRISH
setInterval(function() {
    // HAR DOIM YANGI VERSIYANI TEKSHIRISH
    fetch(`https://yourgithub.github.io/version.json?t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
            if (data.version !== VERSION) {
                console.log("Yangi versiya topildi, yangilanmoqda...");
                localStorage.clear();
                location.reload();
            }
        })
        .catch(e => console.log("Versiya tekshirish xatosi"));
}, 60000);
</script>

</body>
</html>
