<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RekchiAi Ultimate</title>
    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- AdSonar Script -->
    <script src="https://static.sonartech.io/lib/1.0.0/sonar.js?appId=app_c5fa4840"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Share+Tech+Mono&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Poppins', sans-serif;
            height: 100vh; overflow: hidden; color: #333;
            user-select: none;
        }
        
        .app-container {
            max-width: 450px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column;
            background: white; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            padding: 12px 15px; 
            border-bottom: 3px solid #ffd166; 
            z-index: 10;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        
        .balances-group {
            display: flex;
            gap: 6px;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .balances-group::-webkit-scrollbar { display: none; }
        
        .balance-item {
            background: rgba(255, 255, 255, 0.95); 
            padding: 8px 10px; 
            border-radius: 12px;
            font-weight: 800; 
            font-size: 13px; 
            border: 2px solid #ffd166;
            display: flex; align-items: center; justify-content: center;
            gap: 4px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            white-space: nowrap;
            min-width: fit-content;
        }
        
        .b-diamond { color: #ff6b6b; } 
        .b-coin { color: #ff8e53; }
        
        .small-decimal { font-size: 10px; opacity: 0.8; margin-left: 1px; font-weight: 600; }

        .header-actions {
            display: flex; gap: 5px; align-items: center;
        }

        .icon-btn-header {
            width: 42px; height: 42px; background: white; border-radius: 12px;
            border: 2px solid #ffd166; display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: #ff6b6b; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.1s; flex-shrink: 0;
        }
        .icon-btn-header:active { transform: scale(0.95); }

        /* MAIN CONTENT */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; display: none; padding-bottom: 90px; }
        #servicesPage { display: block; } 
        
        .service-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        .service-btn {
            padding: 18px; border: none; border-radius: 20px; font-size: 16px; font-weight: 700;
            color: white; cursor: pointer; display: flex; align-items: center; gap: 15px; width: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; overflow: hidden;
            transition: transform 0.1s;
        }
        .service-btn:active { transform: scale(0.98); }
        .service-icon { font-size: 24px; width: 45px; height: 45px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        /* Colors */
        .instagram { background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); }
        .telegram { background: linear-gradient(135deg, #0088cc, #34aadc); }
        .tiktok { background: linear-gradient(135deg, #000000, #25f4ee, #fe2c55); }
        .youtube { background: linear-gradient(135deg, #FF0000, #CC0000); }
        .game { background: linear-gradient(135deg, #9C27B0, #673AB7); }
        .special { background: linear-gradient(135deg, #FF9800, #FF5722); }

        /* Tabs */
        .tabs-container { display: flex; background: #eee; padding: 5px; border-radius: 15px; margin-bottom: 20px; gap: 5px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 12px; font-weight: 600; color: #666; cursor: pointer; transition: 0.3s; font-size: 13px; }
        .tab-btn.active { background: white; color: #ff6b6b; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* MINER CARDS (1 USTUN) */
        .miner-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        .miner-card { 
            background: #fff; border: 2px solid #eee; border-radius: 20px; padding: 15px 20px; 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; 
            justify-content: space-between; position: relative; overflow: hidden;
        }
        .miner-card:active { transform: scale(0.98); background: #f9f9f9; }
        .miner-card.standard { border-color: #2196F3; }
        .miner-card.pro { border-color: #4CAF50; }
        .miner-card.ultra { border-color: #9C27B0; }
        .miner-card.dragon { border-color: #FF9800; background: #fffdf5; }
        
        .miner-left { display: flex; align-items: center; gap: 15px; }
        .miner-img { font-size: 32px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        .miner-info { text-align: left; }
        .miner-name { font-weight: 800; font-size: 16px; color: #333; margin-bottom: 2px; }
        .miner-time { font-size: 12px; color: #888; font-weight: 500; }
        
        .miner-price { font-weight: 700; font-size: 14px; padding: 8px 15px; border-radius: 12px; white-space: nowrap; }
        .price-diamond { color: #ff6b6b; background: #ffebee; }
        .price-coin { color: #ff8e53; background: #fff3e0; }

        /* --- BANK CARD STYLE --- */
        .bank-card {
            background: linear-gradient(135deg, #1c1c1c 0%, #2c3e50 100%);
            border-radius: 20px;
            padding: 25px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            margin-bottom: 25px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
            min-height: 140px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .bank-card:active { transform: scale(0.98); }
        
        .bank-card-bg-icon {
            position: absolute;
            right: -20px;
            bottom: -20px;
            font-size: 120px;
            color: rgba(255,255,255,0.05);
            transform: rotate(-15deg);
            pointer-events: none;
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-chip {
            width: 45px;
            height: 35px;
            background: linear-gradient(135deg, #d4af37 0%, #f2e3b6 50%, #d4af37 100%);
            border-radius: 6px;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }
        .card-chip::before { content: ''; position: absolute; top: 12px; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.3); }
        .card-chip::after { content: ''; position: absolute; top: 22px; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.3); }

        .card-nfc { font-size: 24px; color: rgba(255,255,255,0.7); transform: rotate(90deg); }

        .card-balance-container {
            margin-top: 10px;
        }
        
        .card-balance-label { font-size: 12px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        
        .card-balance-value { 
            font-family: 'Share Tech Mono', monospace; 
            font-size: 28px; 
            letter-spacing: 1px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .card-logo {
            position: absolute;
            bottom: 20px;
            right: 25px;
            font-size: 24px;
            opacity: 0.8;
            font-weight: 800; font-style: italic;
        }

        /* Active Miners List */
        .active-miner { 
            background: linear-gradient(135deg, #f6f8f9, #e5ebee); border: 1px solid #ccc; 
            border-radius: 12px; padding: 12px 15px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .active-miner-left { display: flex; align-items: center; gap: 12px; }
        .active-miner-icon { font-size: 24px; }
        .active-miner-name { font-weight: 800; font-size: 14px; text-transform: capitalize; color: #333; }
        .active-miner-status { font-size: 10px; color: #4CAF50; font-weight: 600; }
        .active-miner-timer { 
            font-weight: 700; font-family: monospace; font-size: 14px; 
            color: #fff; background: #0088cc; padding: 4px 8px; border-radius: 8px; 
        }

        /* Buttons & Inputs */
        .submit-btn { 
            width: 100%; padding: 15px; border: none; border-radius: 15px; 
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); 
            color: white; font-weight: 800; font-size: 16px; cursor: pointer; 
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.4); margin-top: 10px;
        }
        .submit-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        .submit-btn:active { transform: scale(0.95); }
        .custom-input, .link-input { 
            width: 100%; padding: 14px; border: 2px solid #ffd166; border-radius: 12px; 
            margin-bottom: 15px; text-align: center; font-size: 16px; outline: none; background: #fff; 
        }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; border-radius: 25px; padding: 25px; width: 90%; max-width: 380px;
            text-align: center; position: relative; border: 4px solid #ffd166;
            animation: popIn 0.3s ease; max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .close-btn { position: absolute; top: 15px; right: 15px; background: #ff6b6b; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }

        /* 1 Ta Ustunli Paketlar */
        .quantity-options { display: grid; grid-template-columns: 1fr; gap: 10px; margin: 15px 0; }
        .quantity-btn { 
            padding: 15px; border: 2px solid #ffd166; background: white; border-radius: 12px; 
            font-weight: 700; font-size: 15px; cursor: pointer; transition: 0.2s; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .quantity-btn:active { background: #fff8e1; transform: scale(0.98); }

        /* Shop Styles */
        .shop-grid { display: grid; gap: 10px; margin-top: 10px; }
        .shop-item {
            background: #f8f9fa; padding: 15px; border-radius: 15px; border: 2px solid #eee;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s;
        }
        .shop-item:active { transform: scale(0.98); border-color: #ff6b6b; }
        .shop-price { background: #ffd166; padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 12px; }

        /* Navigation */
        .navigation {
            display: flex; background: white; height: 75px; border-top: 2px solid #ffd166;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); padding-bottom: 5px; position: absolute; bottom: 0; width: 100%; z-index: 20;
        }
        .nav-btn {
            flex: 1; border: none; background: none; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #888; cursor: pointer; transition: 0.3s;
        }
        .nav-btn.active { color: #ff6b6b; }
        .nav-btn.active .nav-icon { transform: translateY(-3px); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-btn span { font-size: 10px; font-weight: 600; }

        /* Notification Toast */
        .notification { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-200%); 
            padding: 15px 25px; border-radius: 15px; background: #4CAF50; color: white; 
            font-weight: 600; z-index: 2000; transition: transform 0.5s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
            display: flex; align-items: center; gap: 10px; min-width: 250px; justify-content: center;
        }
        .notification.error { background: #ff5252; }
        .notification.show { transform: translateX(-50%) translateY(0); }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ff6b6b; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Floating Elements */
        .floating-coins { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .coin { position: absolute; font-size: 24px; opacity: 0; animation: float 15s linear infinite; }
        @keyframes float { 0% { transform: translateY(110vh); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-10vh); opacity: 0; } }
        
        /* Admin Section Style */
        .adm-section {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 10px;
        }
        
        /* Admin Search Styles */
        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .input-group .custom-input {
            margin-bottom: 0;
            flex: 1;
            text-align: left;
            padding-left: 15px;
        }
        .search-btn {
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 12px;
            width: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .search-btn:active { transform: scale(0.95); }

        /* Admin Info Box */
        .user-info-box {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #0d47a1;
            text-align: left;
            display: none; 
        }

        /* Referral Item Style */
        .ref-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }
        .ref-item:last-child { border-bottom: none; }
        .ref-item:hover { background: #f9f9f9; }
        .ref-icon { color: #888; font-size: 14px; }
        .ref-name { font-weight: 700; color: #333; font-size: 14px; }
    </style>
</head>
<body>
    <div class="notification" id="notif"></div>
    <div class="floating-coins" id="floatingCoins"></div>

    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-content">
                <div class="balances-group">
                    <div class="balance-item b-diamond" id="uDiamond">üíé 0</div>
                    <div class="balance-item b-coin" id="uCoin">ü™ô 0.<span class="small-decimal">0000</span></div>
                </div>
                
                <div class="header-actions">
                    <!-- SHOP BUTTON -->
                    <button class="icon-btn-header" onclick="window.openShop()">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <!-- ADMIN BUTTON -->
                    <button class="icon-btn-header" id="adminBtn" onclick="window.openAdmin()" style="display:none; background:#333; color:gold; border-color:gold;">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 1. SERVICES PAGE -->
        <div class="main-content page-content" id="servicesPage">
            <div class="service-grid">
                <button class="service-btn instagram" onclick="openModal('instagram-views')"><div class="service-icon" style="color:#E4405F"><i class="fab fa-instagram"></i></div><div class="service-text">Instagram Ko'rishlar</div></button>
                <button class="service-btn instagram" onclick="openModal('instagram-shares')"><div class="service-icon" style="color:#E4405F"><i class="fas fa-share-alt"></i></div><div class="service-text">Instagram Jo'natishlar</div></button>
                <button class="service-btn telegram" onclick="openModal('telegram-views')"><div class="service-icon" style="color:#0088cc"><i class="fab fa-telegram"></i></div><div class="service-text">Telegram Ko'rishlar</div></button>
                <button class="service-btn telegram" onclick="openModal('telegram-reactions')"><div class="service-icon" style="color:#0088cc"><i class="fas fa-heart"></i></div><div class="service-text">Telegram Reaksiya</div></button>
                <button class="service-btn tiktok" onclick="openModal('tiktok-views')"><div class="service-icon" style="color:#000"><i class="fab fa-tiktok"></i></div><div class="service-text">TikTok Ko'rishlar</div></button>
            </div>
        </div>

        <!-- 2. EARN PAGE -->
        <div class="main-content page-content" id="earnPage">
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('earn', 'ads', this)">Reklama</button>
                <button class="tab-btn" onclick="switchTab('earn', 'promo', this)">Kod</button>
                <button class="tab-btn" onclick="switchTab('earn', 'ref', this)">Do'stlar</button>
            </div>

            <div id="earn-ads" class="earn-sec">
                <div class="ad-container" style="background:white; padding:25px; border-radius:20px; text-align:center;">
                    <div style="font-size:50px; margin-bottom:10px;">üì∫</div>
                    <p style="color:#666; margin-bottom:20px;">Reklama ko'rib olmos ishlang!</p>
                    <button class="submit-btn" id="watchAdBtn">Ko'rish (+1 üíé)</button>
                </div>
            </div>

            <div id="earn-promo" class="earn-sec" style="display:none">
                <div class="ad-container" style="background:white; padding:25px; border-radius:20px;">
                    <h3 style="color:#ff6b6b; margin-bottom:10px;">Promokod</h3>
                    <input type="text" id="promoInput" class="custom-input" placeholder="CODE..." style="text-transform:uppercase">
                    <button class="submit-btn" onclick="activatePromo()">Ishlatish</button>
                </div>
            </div>

            <div id="earn-ref" class="earn-sec" style="display:none">
                <div class="ad-container" style="background:white; padding:25px; border-radius:20px;">
                    <h3 style="color:#0088cc; margin-bottom:10px;">Yangi do'stingiz sizni kodni promakod bo'limiga kiritsa :  do'stingizga 5 üíé olmos, sizga 20 üíé olmos beriladi.</h3>
                    <div class="ref-box" style="background:#f0f4f8; padding:15px; border-radius:10px; border:2px dashed #0088cc; margin-bottom:15px; font-size:20px; font-weight:800;">
                        <span id="myRefCode">...</span>
                    </div>
                    <button class="submit-btn" onclick="copyRef()">Koddan Nusxa Olish</button>
                    <div id="refList" style="margin-top:15px; max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:10px;"></div>
                </div>
            </div>
        </div>

        <!-- 3. MINING PAGE -->
        <div class="main-content page-content" id="swapPage">
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('mining', 'coin', this)">ü™ô Tanga Mayning</button>
                <button class="tab-btn" onclick="switchTab('mining', 'som', this)">üá∫üáø So'm Mayning</button>
            </div>

            <!-- COIN MINING -->
            <div id="mining-coin" class="mining-sec">
                <div class="miner-grid">
                    <!-- Standard -->
                    <div class="miner-card standard" onclick="buyMiner('standard')">
                        <div class="miner-left">
                            <div class="miner-img">üíª</div>
                            <div class="miner-info">
                                <div class="miner-name">Standart</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-diamond">50 üíé</div>
                    </div>
                    <!-- Pro -->
                    <div class="miner-card pro" onclick="buyMiner('pro')">
                        <div class="miner-left">
                            <div class="miner-img">üöÄ</div>
                            <div class="miner-info">
                                <div class="miner-name">Pro</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-diamond">100 üíé</div>
                    </div>
                    <!-- Ultra -->
                    <div class="miner-card ultra" onclick="buyMiner('ultra')">
                        <div class="miner-left">
                            <div class="miner-img">‚ö°</div>
                            <div class="miner-info">
                                <div class="miner-name">Ultra</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-diamond">500 üíé</div>
                    </div>
                    <!-- Dragon -->
                    <div class="miner-card dragon" onclick="buyMiner('dragon')">
                        <div class="miner-left">
                            <div class="miner-img">üê≤</div>
                            <div class="miner-info">
                                <div class="miner-name">Dragon</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-diamond">2000 üíé</div>
                    </div>
                </div>
            </div>

            <!-- SOM MINING -->
            <div id="mining-som" class="mining-sec" style="display:none">
                <!-- BANK CARD STYLE WALLET -->
                <div class="bank-card" onclick="openWithdraw()">
                    <i class="fas fa-wallet bank-card-bg-icon"></i>
                    
                    <div class="card-top">
                        <div class="card-chip"></div>
                        <i class="fas fa-wifi card-nfc"></i>
                    </div>
                    
                    <div class="card-balance-container">
                        <div class="card-balance-label">Sizning Balansingiz</div>
                        <div class="card-balance-value" id="pageSomBalance">0.<span class="small-decimal">0000</span> UZS</div>
                    </div>
                    
                    <div class="card-logo" style="bottom:15px; right:20px; font-weight:bold; font-style:italic;">WALLET</div>
                </div>

                <div class="miner-grid">
                    <!-- Kore -->
                    <div class="miner-card standard" onclick="buyMiner('kore')">
                        <div class="miner-left">
                            <div class="miner-img">üõ†</div>
                            <div class="miner-info">
                                <div class="miner-name">Kore</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-coin">100 ü™ô</div>
                    </div>
                    <!-- Power -->
                    <div class="miner-card pro" onclick="buyMiner('power')">
                        <div class="miner-left">
                            <div class="miner-img">üîã</div>
                            <div class="miner-info">
                                <div class="miner-name">Power</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-coin">300 ü™ô</div>
                    </div>
                    <!-- Turbo -->
                    <div class="miner-card ultra" onclick="buyMiner('turbo')">
                        <div class="miner-left">
                            <div class="miner-img">üèé</div>
                            <div class="miner-info">
                                <div class="miner-name">Turbo</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-coin">1000 ü™ô</div>
                    </div>
                    <!-- Titan -->
                    <div class="miner-card dragon" onclick="buyMiner('titan')">
                        <div class="miner-left">
                            <div class="miner-img">ü§ñ</div>
                            <div class="miner-info">
                                <div class="miner-name">Titan</div>
                                <div class="miner-time">Muddat: 24 soat</div>
                            </div>
                        </div>
                        <div class="miner-price price-coin">3000 ü™ô</div>
                    </div>
                </div>
            </div>

            <h3 style="margin:25px 0 10px 10px; font-size:15px; color:#333;">Faol Maynerlar</h3>
            <div id="activeMinersList"></div>
        </div>

        <!-- 4. PRO PAGE -->
        <div class="main-content page-content" id="proPage">
            <div class="service-grid">
                <button class="service-btn instagram" onclick="openModal('instagram-like')"><div class="service-icon" style="color:#E4405F"><i class="fas fa-heart"></i></div><div class="service-text">Instagram Like</div></button>
                <button class="service-btn instagram" onclick="openModal('instagram-followers')"><div class="service-icon" style="color:#E4405F"><i class="fas fa-users"></i></div><div class="service-text">Instagram Obunachi</div></button>
                <button class="service-btn instagram" onclick="openModal('instagram-story-like')"><div class="service-icon" style="color:#E4405F"><i class="fas fa-history"></i></div><div class="service-text">Instagram Storis Like</div></button>
                <button class="service-btn telegram" onclick="openModal('telegram-followers')"><div class="service-icon" style="color:#0088cc"><i class="fas fa-users"></i></div><div class="service-text">Telegram Obunachi</div></button>
                <button class="service-btn telegram" onclick="openModal('telegram-story-views')"><div class="service-icon" style="color:#0088cc"><i class="fas fa-eye"></i></div><div class="service-text">Telegram Storis Ko'rish</div></button>
                <button class="service-btn tiktok" onclick="openModal('tiktok-followers')"><div class="service-icon" style="color:#000"><i class="fas fa-users"></i></div><div class="service-text">TikTok Obunachi</div></button>
                <button class="service-btn tiktok" onclick="openModal('tiktok-like')"><div class="service-icon" style="color:#000"><i class="fas fa-heart"></i></div><div class="service-text">TikTok Like</div></button>
                <button class="service-btn youtube" onclick="openModal('youtube-like')"><div class="service-icon" style="color:#FF0000"><i class="fab fa-youtube"></i></div><div class="service-text">YouTube Like</div></button>
                
                <button class="service-btn special" onclick="openModal('telegram-stars')"><div class="service-icon" style="color:#FF9800"><i class="fas fa-star"></i></div><div class="service-text">Telegram Stars</div></button>
                <button class="service-btn special" onclick="openModal('telegram-gifts')"><div class="service-icon" style="color:#FF9800"><i class="fas fa-gift"></i></div><div class="service-text">Telegram Gifts</div></button>
                <button class="service-btn special" onclick="openModal('telegram-premium')"><div class="service-icon" style="color:#FF9800"><i class="fab fa-telegram"></i></div><div class="service-text">Telegram Premium</div></button>
                <button class="service-btn special" onclick="openModal('telegram-number')"><div class="service-icon" style="color:#FF9800"><i class="fas fa-phone"></i></div><div class="service-text">Telegram Raqam</div></button>
                <button class="service-btn game" onclick="openModal('pubg-donat')"><div class="service-icon" style="color:#9C27B0"><i class="fas fa-gamepad"></i></div><div class="service-text">PUBG 60 UC</div></button>
                <button class="service-btn game" onclick="openModal('freefire-donat')"><div class="service-icon" style="color:#9C27B0"><i class="fas fa-fire"></i></div><div class="service-text">FreeFire 110</div></button>
            </div>
        </div>

        <!-- NAVIGATION -->
        <div class="navigation">
            <button class="nav-btn active" onclick="nav('servicesPage', this)"><div class="nav-icon"><i class="fas fa-rocket"></i></div><span>Xizmatlar</span></button>
            <button class="nav-btn" onclick="nav('earnPage', this)"><div class="nav-icon"><i class="fas fa-gem"></i></div><span>Ishlash</span></button>
            <button class="nav-btn" onclick="nav('swapPage', this)"><div class="nav-icon"><i class="fas fa-exchange-alt"></i></div><span>Mayning</span></button>
            <button class="nav-btn" onclick="nav('proPage', this)"><div class="nav-icon"><i class="fas fa-crown"></i></div><span>Pro</span></button>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- Service Modal -->
    <div class="modal" id="mainModal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('mainModal').style.display='none'">√ó</button>
            <h3 id="modalTitle" style="margin-bottom:20px; color:#ff6b6b">Xizmat</h3>
            <div id="modalBody"></div>
            <div id="modalFooter" style="margin-top:10px;"></div>
            <div class="loader" id="loader"></div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('shopModal').style.display='none'">√ó</button>
            <h3 style="margin-bottom:15px; color:#ff6b6b">Do'kon</h3>
            <div class="tabs-container">
                <button class="tab-btn active" onclick="setShop('diamond', this)">üíé Olmos</button>
                <button class="tab-btn" onclick="setShop('coin', this)">ü™ô Tanga</button>
            </div>
            <div id="shopList" class="shop-grid"></div>

        </div>
    </div>

    <!-- Admin Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('adminModal').style.display='none'">√ó</button>
            <h3 style="color:gold; margin-bottom:15px;">Admin Panel</h3>
            <div id="adminContent">
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchAdminTab('promo', this)">Promo</button>
                    <button class="tab-btn" onclick="switchAdminTab('channel', this)">Kanal</button>
                    <button class="tab-btn" onclick="switchAdminTab('deduct', this)">Ayirish</button>
                </div>
                
                <div id="adm-promo" class="adm-section">
                    <input id="admCode" class="custom-input" placeholder="Kod nomi">
                    <input id="admAmt" type="number" class="custom-input" placeholder="Miqdor">
                    <select id="admType" class="custom-input"><option value="diamond">Olmos</option><option value="coin">Tanga</option></select>
                    <input id="admMax" type="number" class="custom-input" placeholder="Limit">
                    <button class="submit-btn" onclick="admAddPromo()">Yaratish</button>
                </div>

                <div id="adm-channel" class="adm-section" style="display:none;">
                    <div id="admChanList" style="max-height:100px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee;"></div>
                    <input id="admChanInput" class="custom-input" placeholder="@username">
                    <button class="submit-btn" onclick="admAddChan()">Qo'shish</button>
                </div>

                <!-- DEDUCT SECTION -->
                <div id="adm-deduct" class="adm-section" style="display:none;">
                    <h4 style="margin-bottom:10px; color:#333;">So'm Ayirish</h4>
                    
                    <div class="input-group">
                        <input id="admDedTarget" class="custom-input" placeholder="ID yoki Username (@siz)" style="margin-bottom:0;">
                        <button class="search-btn" onclick="admSearchUser()"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <!-- Topilgan user ma'lumoti -->
                    <div id="admUserInfo" class="user-info-box"></div>

                    <input id="admDedAmount" type="number" class="custom-input" placeholder="Summa (so'm)">
                    <button class="submit-btn" style="background:red;" onclick="admDeductSom()">Ayirish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('withdrawModal').style.display='none'">√ó</button>
            <h3 style="color:#4CAF50; margin-bottom:15px;">Pul Yechish</h3>
            <p style="font-size:12px; color:#666;">Minimal: 10,000 UZS</p>
            <input type="number" id="wAmt" class="custom-input" placeholder="Summa">
            <button class="submit-btn" style="background:#4CAF50" onclick="withdraw()">Yechish (Admin)</button>
        </div>
    </div>

    <!-- Sub Modal -->
    <div class="modal" id="subModal" style="display:none; z-index:2000">
        <div class="modal-content">
            <h3 style="color:#ff6b6b; margin-bottom:10px;">Ilovadan foydalanish uchun kanalga obuna bo'ling va tekshirishni bosing :</h3>
            <div id="subList" style="text-align:center; margin-bottom:15px;"></div>
            <button class="submit-btn" onclick="checkSubs()" style="background:#4CAF50;">Tekshirish</button>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const BACKEND_URL = 'https://68ed1ab05ca4e.myxvest1.ru/manage_balance.php'; 
    const ADMIN_URL = 'https://t.me/Sarvarxon_Anvarovich';
    const ADMIN_GIFT = 'https://t.me/behruz_aura';
    
    const tg = window.Telegram.WebApp;
    tg.expand();
    const userId = tg.initDataUnsafe?.user?.id || '123456789';
    const username = tg.initDataUnsafe?.user?.username || 'Guest';

    let user = { d: 0, c: 0, s: 0, ref: '' };
    let curService = null;
    let selQty = 0;
    let selPrice = 0;
    let shopType = 'diamond';
    let activeMinersList = []; // For local simulation

    // Miner Rates per second
    const MINER_INFO = {
        'standard': { type: 'c', rate: 12 / 86400, icon: 'üíª' },
        'pro':      { type: 'c', rate: 25 / 86400, icon: 'üöÄ' },
        'ultra':    { type: 'c', rate: 130 / 86400, icon: '‚ö°' },
        'dragon':   { type: 'c', rate: 550 / 86400, icon: 'üê≤' },
        'kore':     { type: 's', rate: 3000 / 86400, icon: 'üõ†' },
        'power':    { type: 's', rate: 9000 / 86400, icon: 'üîã' },
        'turbo':    { type: 's', rate: 30000 / 86400, icon: 'üèé' },
        'titan':    { type: 's', rate: 90000 / 86400, icon: 'ü§ñ' }
    };

    // --- SERVICES DATA (Aniq paketlar bilan) ---
    const services = {
        'instagram-views': { 
            name: 'Instagram Ko\'rishlar', id: 278, min: 1001, price: 0.025, 
            packages: [ { qty: 1001, price: 26 },{ qty: 2000, price: 50 }, { qty: 5000, price: 125 }, { qty: 10000, price: 250 } ], currency: 'diamond', placeholder: 'Post Linki' },
        'instagram-shares': { name: 'Instagram Jo\'natishlar', id: 292, min: 10, price: 0.14, packages: [ { qty: 20, price: 3 }, { qty: 50, price: 7 }, { qty: 100, price: 14 } ], currency: 'diamond', placeholder: 'Post Linki' },
        'telegram-views': { name: 'Telegram Ko\'rishlar', id: 58, min: 100, price: 0.025, packages: [ { qty: 200, price: 5 }, { qty: 500, price: 13 }, { qty: 1000, price: 25 } ], currency: 'diamond', placeholder: 'Post Linki' },
        'telegram-reactions': { name: 'Telegram Reaksiya', id: 74, min: 10, price: 0.2, packages: [ { qty: 10, price: 2 }, { qty: 20, price: 4 }, { qty: 50, price: 10 } ], currency: 'diamond', placeholder: 'Post Linki' },
        'tiktok-views': { name: 'TikTok Ko\'rishlar', id: 410, min: 100, price: 0.025, packages: [ { qty: 200, price: 5 }, { qty: 500, price: 13 }, { qty: 1000, price: 25 } ], currency: 'diamond', placeholder: 'Video Linki' },
        
        'instagram-like': { name: 'Instagram Like', id: 577, min: 10, price: 0.2, packages: [ { qty: 10, price: 2 }, { qty: 20, price: 4 }, { qty: 50, price: 10 }, { qty: 100, price: 20 } ], currency: 'coin', placeholder: 'Post Linki' },
        'instagram-followers': { name: 'Instagram Obunachi', id: 218, min: 10, price: 0.8, packages: [ { qty: 10, price: 8 }, { qty: 20, price: 16 }, { qty: 50, price: 40 }, { qty: 100, price: 80 } ], currency: 'coin', placeholder: 'Username' },
        'instagram-story-like': { name: 'Instagram Storis Like', id: 1158, min: 10, price: 0.2, packages: [ { qty: 10, price: 2 }, { qty: 20, price: 4 }, { qty: 50, price: 10 }, { qty: 100, price: 20 } ], currency: 'coin', placeholder: 'Story Link' },
        'telegram-followers': { name: 'Telegram Obunachi', id: 1477, min: 500, price: 0.8, packages: [ { qty: 500, price: 400 }, { qty: 600, price: 480 }, { qty: 700, price: 560 }, { qty: 800, price: 640 } ], currency: 'coin', placeholder: 'Kanal Linki' },
        'telegram-story-views': { name: 'Telegram Storis Ko\'rish', id: 1115, min: 10, price: 0.1, packages: [ { qty: 10, price: 1 }, { qty: 20, price: 2 }, { qty: 50, price: 5 }, { qty: 100, price: 10 } ], currency: 'coin', placeholder: 'Story Link' },
        'tiktok-followers': { name: 'TikTok Obunachi', id: 1420, min: 10, price: 0.8, packages: [ { qty: 10, price: 8 }, { qty: 20, price: 16 }, { qty: 50, price: 40 }, { qty: 100, price: 80 } ], currency: 'coin', placeholder: 'Profil Linki' },
        'tiktok-like': { name: 'TikTok Like', id: 1470, min: 20, price: 0.05, packages: [ { qty: 20, price: 1 }, { qty: 40, price: 2 }, { qty: 100, price: 5 }, { qty: 500, price: 25 } ], currency: 'coin', placeholder: 'Video Linki' },
        'youtube-like': { name: 'YouTube Like', id: 1498, min: 10, price: 0.2, packages: [ { qty: 10, price: 2 }, { qty: 20, price: 4 }, { qty: 50, price: 10 }, { qty: 100, price: 20 } ], currency: 'coin', placeholder: 'Video Linki' },
        'telegram-stars': { name: 'Telegram Stars', id: 467, min: 50, price: 5, packages: [ { qty: 50, price: 250 }, { qty: 100, price: 500 }, { qty: 150, price: 750 } ], currency: 'coin', placeholder: 'Username' },
        
        'telegram-premium': { name: 'Telegram Premium', price: 1125, type: 'admin', currency: 'coin', link: ADMIN_URL, msg: 'Premium kerak' },
        'telegram-gifts': { name: 'Telegram Gifts', price: 99, type: 'admin', currency: 'coin', link: ADMIN_GIFT, msg: 'Gifts kerak' },
        'telegram-number': { name: 'Telegram Raqam', price: 399, type: 'admin', currency: 'coin', link: ADMIN_URL, msg: 'Raqam kerak' },
        'pubg-donat': { name: 'Pubg 60 UC', price: 325, type: 'admin', currency: 'coin', link: ADMIN_URL, msg: 'Assalomu aleykum PUBG 60 UC kerak Narxi:325 tanga' },
        'freefire-donat': { name: 'FreeFire 110 almaz', price: 375, type: 'admin', currency: 'coin', link: ADMIN_URL, msg: 'Assalomu aleykum FreeFire 110 Almaz kerak Narxi:375 tanga' }
    };

    // --- API WRAPPER ---
    async function api(action, data = {}) {
        try {
            let body = { action, user_id: userId, username: username, ...data };
            let headers = {
                'Content-Type': 'application/json',
                'X-Telegram-Data': tg.initData 
            };
            body.key = '4564123:hkjhfadfhieapkdnga';
            let req = await fetch(BACKEND_URL, { method: 'POST', headers, body: JSON.stringify(body) });
            return await req.json();
        } catch (e) { return { success: false, message: 'Internet xatosi' }; }
    }

    // --- INIT ---
    window.onload = async () => {
        await fetchBalance();
        checkSubs();
        loadMiners();
        loadRefs();
        createCoins();
        
        // Backend Update (every 10s)
        setInterval(fetchBalance, 10000); 
        
        // Frontend Simulation (every 0.1s)
        startMiningSimulation();
        // Timer countdown loop (every 1s)
        setInterval(startMinerTimer, 1000);
    };

    async function fetchBalance() {
        let res = await api('get_balance');
        if(res.success) {
            user.d = parseInt(res.diamonds); 
            user.c = parseFloat(res.coins); 
            user.s = parseFloat(res.som_balance); 
            user.ref = res.referral_code;
            updateUI();
            
            if(res.is_admin === 1) {
                document.getElementById('adminBtn').style.display = 'flex';
            }
        }
    }

    function updateUI() {
        document.getElementById('uDiamond').innerText = `üíé ${user.d}`;
        let cStr = user.c.toFixed(4).split('.');
        document.getElementById('uCoin').innerHTML = `ü™ô ${cStr[0]}.<span class="small-decimal">${cStr[1]}</span>`;
        let sStr = user.s.toFixed(4).split('.');
        document.getElementById('pageSomBalance').innerHTML = `${sStr[0]}.<span class="small-decimal">${sStr[1]}</span> UZS`;
        
        document.getElementById('myRefCode').innerText = user.ref;
    }

    // --- REAL-TIME SIMULATION ---
    function startMiningSimulation() {
        setInterval(() => {
            let coinInc = 0;
            let somInc = 0;
            
            activeMinersList.forEach(m => {
                if(m.time_left > 0) {
                    let info = MINER_INFO[m.type];
                    if(info) {
                        let step = info.rate / 10;
                        if(info.type === 'c') coinInc += step;
                        if(info.type === 's') somInc += step;
                    }
                }
            });

            if(coinInc > 0 || somInc > 0) {
                user.c += coinInc;
                user.s += somInc;
                updateUI();
            }
        }, 100);
    }

    // --- TIMER ---
    function startMinerTimer() {
        if(activeMinersList.length > 0) {
            let html = '';
            activeMinersList.forEach(m => {
                if(m.time_left > 0) m.time_left--;
                let info = MINER_INFO[m.type] || { icon: '‚ùì' };
                let tStr = m.time_left > 0 ? new Date(m.time_left * 1000).toISOString().substr(11, 8) : "Tugadi";

                html += `
                <div class="active-miner">
                    <div class="active-miner-left">
                        <span class="active-miner-icon">${info.icon}</span>
                        <div>
                            <div class="active-miner-name">${m.type}</div>
                            <div class="active-miner-status">Ishlamoqda...</div>
                        </div>
                    </div>
                    <div class="active-miner-timer">${tStr}</div>
                </div>`;
            });
            document.getElementById('activeMinersList').innerHTML = html;
        } else {
             document.getElementById('activeMinersList').innerHTML = '<p style="text-align:center; color:#999; padding:10px;">Faol mayner yo\'q</p>';
        }
    }

    // --- MINING ---
    async function loadMiners() {
        let res = await api('get_miners');
        if(res.success) { 
            activeMinersList = res.miners; 
            startMinerTimer(); // Initial render
        }
    }

    async function buyMiner(type) {
        if(!confirm(type.toUpperCase() + " sotib olasizmi?")) return;
        let res = await api('buy_miner', {miner_type: type});
        notif(res.success, res.message);
        if(res.success) {
            fetchBalance();
            loadMiners();
        }
    }

    // --- NAVIGATION ---
    window.nav = (page, btn) => {
        document.querySelectorAll('.page-content').forEach(e => e.style.display='none');
        document.getElementById(page).style.display='block';
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        btn.classList.add('active');
        if(page === 'swapPage') loadMiners();
    };

    window.switchTab = (grp, target, btn) => {
        document.querySelectorAll(`.${grp}-sec`).forEach(e => e.style.display='none');
        document.getElementById(`${grp}-${target}`).style.display='block';
        btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    };

    window.switchAdminTab = (target, btn) => {
        document.querySelectorAll('.adm-section').forEach(e => e.style.display='none');
        document.getElementById(`adm-${target}`).style.display='block';
        btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    };

    // --- SERVICES ---
    window.openModal = (key) => {
        curService = services[key];
        if(!curService) return;
        
        let m = document.getElementById('mainModal');
        let b = document.getElementById('modalBody');
        let f = document.getElementById('modalFooter');
        let l = document.getElementById('loader');

        // TUZATISH: Har safar ochilganda ko'rinishni qayta tiklash
        m.style.display = 'flex';
        b.style.display = 'block';
        f.style.display = 'block';
        l.style.display = 'none';

        document.getElementById('modalTitle').innerText = (curService.name || key).toUpperCase();
        f.innerHTML = '';

        if(curService.type === 'admin') {
            b.innerHTML = `
                <div style="background:#fff3e0; padding:15px; border-radius:10px; color:#e65100; font-weight:bold; margin-bottom:10px;">
                    Narxi: ${curService.price} ü™ô
                </div>
            `;
            f.innerHTML = `<button class="submit-btn" onclick="buyAdmin()">Sotib Olish</button>`;
        } else {
            let symbol = curService.currency === 'diamond' ? 'üíé' : 'ü™ô';
            let html = `<div class="quantity-options">`;
            
            if(curService.packages) {
                curService.packages.forEach(pkg => {
                    html += `
                    <div class="quantity-btn" onclick="selQtyFunc(${pkg.qty}, ${pkg.price})">
                        <span>${pkg.qty} ta</span>
                        <span style="color:${symbol === 'üíé' ? '#ff6b6b' : '#ff8e53'}">${pkg.price} ${symbol}</span>
                    </div>`;
                });
            }
            html += `</div>
            <button class="quantity-btn" style="width:100%; justify-content:center;" onclick="customQty()">Boshqa miqdor</button>`;
            
            b.innerHTML = html;
        }
    };

    window.selQtyFunc = (q, p) => { selQty = q; selPrice = p; askLink(); };
    
    window.customQty = () => {
        let b = document.getElementById('modalBody');
        b.innerHTML = `
            <p>Miqdor (Min: ${curService.min})</p>
            <input type="number" class="custom-input" placeholder="0" oninput="calcPrice(this.value)">
            <div id="pricePreview" style="font-weight:bold; color:#ff6b6b; margin-top:10px;"></div>
        `;
        document.getElementById('modalFooter').innerHTML = `<button id="custBtn" class="submit-btn" disabled onclick="askLink()">Davom etish</button>`;
    };

    window.calcPrice = (val) => {
        let q = parseInt(val);
        let btn = document.getElementById('custBtn');
        if(!q || q < curService.min) {
            document.getElementById('pricePreview').innerText = `Min: ${curService.min}`;
            btn.disabled = true;
            return;
        }
        let p = Math.ceil(q * curService.price);
        let sym = curService.currency === 'diamond' ? 'üíé' : 'ü™ô';
        selQty = q; selPrice = p;
        document.getElementById('pricePreview').innerText = `Narxi: ${p} ${sym}`;
        btn.disabled = false;
        btn.innerText = `Davom etish (${p} ${sym})`;
    };

    window.askLink = () => {
        let bal = curService.currency === 'diamond' ? user.d : user.c;
        if(bal < selPrice) { notif(false, 'Mablag\' yetarli emas'); return; }
        
        document.getElementById('modalBody').innerHTML = `
            <div style="font-weight:bold; margin-bottom:10px;">Buyurtma: ${selQty} ta</div>
            <input type="text" id="targetLink" class="custom-input" placeholder="${curService.placeholder}">
        `;
        document.getElementById('modalFooter').innerHTML = `<button class="submit-btn" onclick="submitOrder(this)">Buyurtma Berish</button>`;
    };

    async function submitOrder(btn) {
        let link = document.getElementById('targetLink').value.trim();
        if(!link) return notif(false, 'Iltimos, havolani kiriting');
        
        // Havola formatini tahrirlash
        if(curService.id === 467 && !link.includes('@') && !link.startsWith('http')) {
            link = '@' + link;
        } else if(curService.id !== 218 && curService.id !== 467 && !link.startsWith('http')) {
            link = link;
        }
    
        // Himoya: Double click oldini olish
        btn.disabled = true;
    
        // Loaderni ko'rsatish
        document.getElementById('modalBody').style.display = 'none';
        document.getElementById('modalFooter').style.display = 'none';
        document.getElementById('loader').style.display = 'block';
    
        try {
            let res = await api('order', {
                service_id: curService.id, 
                link: link, 
                quantity: selQty, 
                price: selPrice, 
                currency: curService.currency
            });
            
            document.getElementById('loader').style.display = 'none';
            
            if(res.success) {
                notif(true, '‚úÖ Buyurtma muvaffaqiyatli qabul qilindi!');
                document.getElementById('mainModal').style.display = 'none';
                fetchBalance();
            } else {
                // Backend xatolik xabarini tahlil qilish
                let errorMessage = res.message || 'Noma\'lum xatolik yuz berdi';
                
                // Xatolik xabarlarini tushunarli qilish
                if (errorMessage.includes('duplicate') || 
                    errorMessage.includes('qaytarildi') ||
                    errorMessage.includes('faol')) {
                    errorMessage = '‚ö†Ô∏è Sizda bu havola bo\'yicha faol buyurtma mavjud. Iltimos, bir necha daqiqadan keyin urinib ko\'ring yoki boshqa havola kiriting.';
                } else if (errorMessage.includes('not enough') || 
                          errorMessage.includes('yetarli')) {
                    errorMessage = '‚ùå Balansingizda yetarli mablag\' mavjud emas. Iltimos, balansingizni to\'ldiring.';
                } else if (errorMessage.includes('invalid') || 
                          errorMessage.includes('link')) {
                    errorMessage = '‚ùå Noto\'g\'ri havola formati. Iltimos, to\'g\'ri havola kiriting.';
                } else if (errorMessage.includes('minimum') || 
                          errorMessage.includes('minimal')) {
                    errorMessage = '‚ùå Minimal miqdor: ' + curService.min;
                } else {
                    // Umumiy xatolik xabari
                    errorMessage = '‚ùå Xatolik: ' + errorMessage;
                }
                
                notif(false, errorMessage);
                
                // Formani qayta ko'rsatish
                document.getElementById('modalBody').style.display = 'block';
                document.getElementById('modalFooter').style.display = 'block';
                btn.disabled = false;
            }
        } catch (error) {
            document.getElementById('loader').style.display = 'none';
            notif(false, 'üåê Internet aloqasi xatosi. Iltimos, internetingizni tekshiring.');
            
            // Formani qayta ko'rsatish
            document.getElementById('modalBody').style.display = 'block';
            document.getElementById('modalFooter').style.display = 'block';
            btn.disabled = false;
        }
    }

    async function buyAdmin() {
        if(user.c < curService.price) return notif(false, 'Tanga yetarli emas');
        let msg = `${curService.msg}\n(ID: ${userId}, Balans: ${user.c})`;
        window.open(`${curService.link}?text=${encodeURIComponent(msg)}`, '_blank');
        document.getElementById('mainModal').style.display='none';
    }

    // --- SHOP ---
    window.openShop = () => {
        document.getElementById('shopModal').style.display='flex';
        setShop('diamond', document.querySelector('.tab-btn'));
    };

    window.setShop = (type, btn) => {
        shopType = type;
        if(btn) {
            btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        let pkgs = type === 'diamond' ? 
            [{a:500, p:21000}, {a:1000, p:39000}, {a:2000, p:75000}, {a:3000, p:99000}] : 
            [{a:500, p:26000}, {a:1000, p:51000}, {a:2000, p:99000}, {a:3000, p:120000}];
        
        let sym = type === 'diamond' ? 'üíé' : 'ü™ô';
        let html = '';
        pkgs.forEach(pkg => {
            html += `
            <div class="shop-item" onclick="buyPkg(${pkg.a}, ${pkg.p}, '${sym}')">
                <div style="font-weight:bold; color:#333;">${pkg.a} ${sym}</div>
                <div class="shop-price">${pkg.p.toLocaleString()} so'm</div>
            </div>`;
        });
        document.getElementById('shopList').innerHTML = html;
        document.getElementById('customShopBtn').style.display='none';
        document.getElementById('customShopInput').value='';
        document.getElementById('customShopPreview').innerText='';
    };

    window.buyPkg = (a, p, s) => {
        let msg = `Assalomu aleykum, ${a} ${s} sotib olmoqchiman ${p.toLocaleString()} so'm.`;
        window.open(`${ADMIN_GIFT}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.calcCustomShop = (val) => {
        let a = parseInt(val);
        let btn = document.getElementById('customShopBtn');
        let prev = document.getElementById('customShopPreview');
        
        if(!a || a < 300) { prev.innerText = 'Min: 300'; btn.style.display='none'; return; }
        
        let rate = 42; 
        if(shopType === 'coin') rate = 15;
        
        let price = Math.ceil(a * rate);
        prev.innerText = `Narxi: ${price.toLocaleString()} so'm`;
        btn.style.display='block';
        btn.onclick = () => buyPkg(a, price, shopType === 'diamond' ? 'üíé' : 'ü™ô');
    };

    // --- WITHDRAW ---
    window.openWithdraw = () => { document.getElementById('withdrawModal').style.display='flex'; };
    async function withdraw() {
        let amt = document.getElementById('wAmt').value;
        if(!amt) return notif(false, 'Summa kiritilmadi');
        let res = await api('withdraw', {amount: amt});
        notif(res.success, res.message);
        if(res.success) {
            fetchBalance();
            document.getElementById('withdrawModal').style.display='none';
            window.open(`${ADMIN_GIFT}?text=${encodeURIComponent("Pul yechish so'rovi: " + amt + " so'm.")}`, '_blank');
        }
    }

    // --- ADMIN SEARCH & DEDUCT ---
    async function admSearchUser() {
        let t = document.getElementById('admDedTarget').value;
        if(!t) return notif(false, 'ID yoki Username kiriting');
        
        let res = await api('admin_get_user_info', { target: t });
        
        if(res.success) {
            let div = document.getElementById('admUserInfo');
            div.style.display = 'block';
            div.innerHTML = `Topildi: <b>${res.username}</b><br>Balans: <span style="color:green; font-weight:bold">${res.som_balance} so'm</span>`;
        } else {
            notif(false, 'Foydalanuvchi topilmadi');
        }
    }

    async function admDeductSom() {
        let target = document.getElementById('admDedTarget').value;
        let amount = document.getElementById('admDedAmount').value;
        if(!target || !amount) return notif(false, 'Ma\'lumot yetarli emas');
        
        let res = await api('admin_deduct_som', { target: target, amount: amount });
        if(res.success) {
            notif(true, 'Balansdan muvaffaqiyatli ayrildi');
            document.getElementById('admDedAmount').value = '';
            document.getElementById('admUserInfo').style.display = 'none';
        } else {
            notif(false, res.message);
        }
    }

    // --- EARN (ADS, PROMO, REF) ---
    document.getElementById('watchAdBtn').onclick = () => {
        if(!window.Sonar) return notif(false, 'Ad yuklanmadi');
        window.Sonar.show({ adUnit: "rekchiai", onReward: async () => {
            let res = await api('add', {amount:1});
            if(res.success) { fetchBalance(); notif(true, '+1 üíé'); }
        }});
    };

    async function activatePromo() {
        let c = document.getElementById('promoInput').value;
        if(!c) return;
        let res = await api('activate_code', {code: c});
        notif(res.success, res.message);
        if(res.success) document.getElementById('promoInput').value = '';
        fetchBalance();
    }

    function copyRef() { navigator.clipboard.writeText(user.ref); notif(true, 'Nusxalandi'); }
    
    // TUZATILDI: Referal ro'yxatini toza va vaqtsiz chiqarish
    async function loadRefs() {
        let res = await api('get_referrals');
        let h = '';
        if(res.success && res.referrals.length > 0) {
            res.referrals.forEach(r => {
                // XSS himoyasi uchun
                let safeName = r.username.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                h += `
                <div class="ref-item">
                    <i class="fas fa-user ref-icon"></i>
                    <div class="ref-name">${safeName}</div>
                </div>`;
            });
        } else { 
            h = '<div style="padding:15px; text-align:center; color:#999;">Hali referallar yo\'q</div>'; 
        }
        document.getElementById('refList').innerHTML = h;
    }

    // --- ADMIN ---
    window.openAdmin = async () => {
        document.getElementById('adminModal').style.display='flex';
        let res = await api('admin_get_channels');
        if(res.success) {
            let h = '';
            res.channels.forEach(c => h += `<div style="display:flex; justify-content:space-between;"><span>${c.channel_name}</span><button onclick="admDelChan(${c.id})" style="color:red">X</button></div>`);
            document.getElementById('admChanList').innerHTML = h;
        }
    };
    async function admAddPromo() {
        let d = { code: document.getElementById('admCode').value, amount: document.getElementById('admAmt').value, type: document.getElementById('admType').value, max_uses: document.getElementById('admMax').value };
        await api('admin_add_promo', d);
        notif(true, 'OK');
    }
    async function admAddChan() {
        await api('admin_add_channel', {channel_input: document.getElementById('admChanInput').value});
        notif(true, 'OK');
        window.openAdmin();
    }
    async function admDelChan(id) {
        await api('admin_delete_channel', {db_id: id});
        window.openAdmin();
    }

    // --- SUBS ---
    async function checkSubs() {
        let res = await api('check_subs');
        if(!res.success) return;
        if(!res.all_subscribed) {
            let h = '';
            res.channels.forEach(c => {
                let status = c.is_subscribed ? '‚úÖ' : '‚ùå';
                let link = c.link.startsWith('http') ? c.link : `https://t.me/${c.link.replace('@','')}`;
                if (!c.is_subscribed) {
                     h += `<a href="${link}" target="_blank" class="submit-btn" style="text-decoration:none; display:flex; justify-content:center; align-items:center; margin-bottom:10px; background:#0088cc;">üì¢ Obuna bo'lish</a>`;
                }
            });
            
            if (h !== '') {
                document.getElementById('subList').innerHTML = h;
                document.getElementById('subModal').style.display='flex';
            } else {
                document.getElementById('subModal').style.display='none';
            }
        } else {
            document.getElementById('subModal').style.display='none';
        }
    }

    // --- UTILS ---
    function notif(success, msg) {
        let n = document.getElementById('notif');
        n.innerText = msg;
        n.className = success ? 'notification show' : 'notification error show';
        setTimeout(() => n.className = 'notification', 3000);
    }
    async function checkNotifs() {
        let res = await api('get_notifications');
        if(res.success && res.notifications) res.notifications.forEach(m => notif(true, m));
    }
    function createCoins() {
        const con = document.getElementById('floatingCoins');
        const icons = ['üíé','ü™ô','‚≠ê'];
        for(let i=0; i<15; i++) {
            let el = document.createElement('div');
            el.className = 'coin';
            el.innerText = icons[Math.floor(Math.random()*icons.length)];
            el.style.left = Math.random()*100 + '%';
            el.style.animationDelay = Math.random()*20 + 's';
            con.appendChild(el);
        }
    }
</script>
</body>
</html>
