<!doctype html>
<html lang="uz" class="h-full dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RekchiAi Olmoslari</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.sonartech.io/lib/1.0.0/sonar.js?appId=app_c5fa4840"></script>
    
    <style>
        body { background: #0f0f0f; color: #fff; font-family: sans-serif; }
        .app-card { background: rgba(30,30,30,0.9); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-primary { background: linear-gradient(135deg,#0096ff,#0066cc); color: white; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.95); }
        .menu-item.active { color: #0096ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* Loading spinner */
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #0096ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-full flex flex-col">

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f0f0f]">
        <div class="text-center">
            <div class="spinner mb-4"></div>
            <p id="loading-text" class="text-white/60">Yuklanmoqda...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden flex-1 flex flex-col pb-20">
        <!-- Header -->
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-[#0f0f0f]/90 sticky top-0 z-10">
            <div class="font-bold text-lg">üíé RekchiAi</div>
            <div class="bg-white/10 px-3 py-1 rounded-full flex items-center gap-2">
                <span id="diamond-count" class="font-bold text-yellow-400">0</span>
                <span>üíé</span>
            </div>
        </div>

        <!-- Content -->
        <div class="p-4 space-y-4 flex-1 overflow-y-auto">
            
            <!-- EARN SECTION -->
            <div id="earn-section" class="content-section active space-y-4">
                <div class="app-card p-4 flex items-center gap-3">
                    <div id="user-avatar" class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 overflow-hidden"></div>
                    <div>
                        <h3 id="user-name" class="font-bold">Foydalanuvchi</h3>
                        <p id="user-id" class="text-xs text-white/50">ID: ...</p>
                    </div>
                </div>

                <div class="app-card p-6 text-center">
                    <div class="text-4xl mb-2">üì∫</div>
                    <h2 class="font-bold text-lg mb-1">Reklama ko'ring</h2>
                    <p class="text-white/50 text-sm mb-4">Har bir reklama uchun 1 olmos</p>
                    
                    <p id="ad-status" class="h-6 text-sm mb-2 text-blue-400"></p>
                    
                    <button id="watch-ad-btn" class="btn-primary w-full py-3 rounded-xl font-bold flex justify-center items-center gap-2">
                        <span>‚ñ∂Ô∏è</span> Boshlash
                    </button>
                </div>
            </div>

            <!-- LEADERBOARD SECTION -->
            <div id="leaderboard-section" class="content-section">
                <div class="app-card p-4">
                    <h2 class="font-bold mb-4 flex items-center gap-2">üèÜ Top Reyting</h2>
                    <div id="leaderboard-list" class="space-y-3">
                        <div class="text-center py-4 text-white/50">Yuklanmoqda...</div>
                    </div>
                </div>
            </div>

            <!-- ADMIN SECTION -->
            <div id="admin-section" class="content-section hidden">
                <div class="app-card p-4 border-yellow-500/50 border">
                    <h2 class="font-bold text-yellow-500 mb-4">üëë Admin Panel</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-white/5 p-2 rounded text-center">
                            <div class="text-xl font-bold" id="adm-users">0</div>
                            <div class="text-xs text-white/50">Users</div>
                        </div>
                        <div class="bg-white/5 p-2 rounded text-center">
                            <div class="text-xl font-bold text-blue-400" id="adm-diamonds">0</div>
                            <div class="text-xs text-white/50">Diamonds</div>
                        </div>
                    </div>
                    <button onclick="loadAdminStats()" class="w-full py-2 bg-white/10 rounded">Yangilash</button>
                    <div id="admin-list" class="mt-4 max-h-60 overflow-y-auto space-y-2 text-sm"></div>
                </div>
            </div>

        </div>

        <!-- Menu -->
        <div class="fixed bottom-0 left-0 right-0 bg-[#1a1a1a] border-t border-white/10 p-2 flex justify-around pb-6">
            <button onclick="switchTab('earn-section', this)" class="menu-item active flex flex-col items-center p-2">
                <span class="text-xl">üíé</span>
                <span class="text-xs">Ishlash</span>
            </button>
            <button onclick="switchTab('leaderboard-section', this)" class="menu-item flex flex-col items-center p-2">
                <span class="text-xl">üèÜ</span>
                <span class="text-xs">Reyting</span>
            </button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="hidden fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-red-900/50 border border-red-500 p-6 rounded-xl max-w-sm w-full">
            <h3 class="font-bold text-lg mb-2">Xatolik yuz berdi!</h3>
            <p id="error-text" class="text-sm text-white/80 mb-4">...</p>
            <button onclick="location.reload()" class="bg-white text-black px-4 py-2 rounded w-full font-bold">Qayta yuklash</button>
        </div>
    </div>

    <script>
        // API CONFIG
        const API_URL = 'https://68ed1ab05ca4e.myxvest1.ru/api.php';
        const API_KEY = '4564123:hkjhfadfhieapkdnga';
        const ADSONAR_ID = "rekchiai";
        const ADMIN_IDS = ['7500103239', '7104718080']; // O'zingizning ID'ingizni yozing

        let currentUser = null;
        let isWatchingAd = false;

        // INIT
        window.onload = async () => {
            initUser();
            await loginUser();
        };

        function initUser() {
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                const u = tg.initDataUnsafe?.user;
                if (u) {
                    currentUser = {
                        user_id: u.id.toString(),
                        username: u.username || '',
                        first_name: u.first_name || 'User',
                        photo_url: u.photo_url || ''
                    };
                }
            }
            // Test user (Agar telegramdan kirmasa)
            if (!currentUser) {
                currentUser = {
                    user_id: 'test_12345',
                    username: 'test_user',
                    first_name: 'Test Account',
                    photo_url: ''
                };
            }
        }

        async function loginUser() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        key: API_KEY,
                        action: 'login',
                        user_id: currentUser.user_id,
                        username: currentUser.username,
                        first_name: currentUser.first_name,
                        photo_url: currentUser.photo_url
                    })
                });

                // Serverdan kelgan javobni matn sifatida olib ko'ramiz (agar JSON bo'lmasa xatoni ko'rish uchun)
                const text = await res.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error("Server xatosi (JSON emas): " + text.substring(0, 100));
                }

                if (data.success) {
                    updateUI(data.user);
                    if (ADMIN_IDS.includes(currentUser.user_id)) {
                        document.getElementById('admin-section').classList.remove('hidden');
                        loadAdminStats();
                    }
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                showError(err.message);
            }
        }

        async function claimReward() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        key: API_KEY,
                        action: 'add_diamond',
                        user_id: currentUser.user_id
                    })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('diamond-count').textContent = data.new_balance;
                    setStatus("Muvaffaqiyatli! +1 Olmos", "text-green-400");
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<div class="text-center py-2 text-white/50">Yuklanmoqda...</div>';
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ key: API_KEY, action: 'get_leaderboard' })
                });
                const data = await res.json();
                
                if (data.success && data.leaderboard.length > 0) {
                    list.innerHTML = data.leaderboard.map((u, i) => `
                        <div class="flex items-center gap-3 bg-white/5 p-2 rounded-lg">
                            <div class="font-bold text-yellow-500 w-6 text-center">${i+1}</div>
                            <div class="w-8 h-8 rounded-full bg-gray-700 overflow-hidden">
                                ${u.photo_url ? `<img src="${u.photo_url}" class="w-full h-full object-cover">` : ''}
                            </div>
                            <div class="flex-1 text-sm">
                                <div class="font-bold">${safe(u.first_name)}</div>
                            </div>
                            <div class="font-bold text-blue-400">${u.diamonds} üíé</div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="text-center py-2 text-white/50">Ro\'yxat bo\'sh</div>';
                }
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-400">Xatolik</div>';
            }
        }

        async function loadAdminStats() {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ key: API_KEY, action: 'admin_stats' })
            });
            const data = await res.json();
            if(data.success) {
                document.getElementById('adm-users').textContent = data.total_users;
                document.getElementById('adm-diamonds').textContent = data.total_diamonds;
                document.getElementById('admin-list').innerHTML = data.users.map(u => `
                    <div class="flex justify-between bg-white/5 p-1 rounded">
                        <span>${safe(u.first_name)}</span>
                        <span class="text-yellow-400">${u.diamonds}</span>
                    </div>
                `).join('');
            }
        }

        // --- HELPER FUNCTIONS ---
        function updateUI(user) {
            document.getElementById('user-name').textContent = user.first_name || currentUser.first_name;
            document.getElementById('user-id').textContent = `ID: ${currentUser.user_id}`;
            document.getElementById('diamond-count').textContent = user.diamonds;
            
            const ava = document.getElementById('user-avatar');
            const pic = user.photo_url || currentUser.photo_url;
            if(pic) ava.innerHTML = `<img src="${pic}" class="w-full h-full object-cover">`;
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.content-section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(id === 'leaderboard-section') loadLeaderboard();
        }

        function setStatus(msg, cls) {
            const el = document.getElementById('ad-status');
            el.textContent = msg;
            el.className = "h-6 text-sm mb-2 " + cls;
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-text').textContent = msg;
        }

        function safe(str) {
            return str ? str.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
        }

        // --- ADSONAR LOGIC ---
        document.getElementById('watch-ad-btn').addEventListener('click', () => {
            if(isWatchingAd) return;
            if(!window.Sonar) { alert("Reklama yuklanmadi"); return; }
            
            isWatchingAd = true;
            setStatus("Reklama yuklanmoqda...", "text-blue-400");
            const btn = document.getElementById('watch-ad-btn');
            btn.disabled = true;
            btn.style.opacity = 0.5;

            window.Sonar.show({
                adUnit: ADSONAR_ID,
                onReward: () => claimReward(),
                onClose: () => {
                    isWatchingAd = false;
                    btn.disabled = false;
                    btn.style.opacity = 1;
                    if(document.getElementById('ad-status').textContent.includes("Yuklanmoqda")) {
                         setStatus("", "");
                    }
                },
                onError: (e) => {
                    isWatchingAd = false;
                    btn.disabled = false;
                    btn.style.opacity = 1;
                    setStatus("Xatolik yuz berdi", "text-red-400");
                }
            });
        });
    </script>
</body>
</html>
