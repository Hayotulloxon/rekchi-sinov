<!doctype html>
<html lang="uz" class="h-full dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RekchiAi olmoslari</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>
    <style>
        /* (O'zgarmagan stil qismi shu yerda saqlanadi) */
        /* ...styling omitted for brevity in this snippet - keep original styles... */
        body {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
        }
        /* (boshqa CSS larni original fayldan nusxa qilib shu yerda saqlang) */
        /* For brevity, full CSS from original file should remain here unchanged */
        /* ... */
    </style>
</head>
<body class="h-full gradient-bg text-white overflow-auto">
    <div id="app" class="min-h-full w-full">
        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center min-h-screen p-4">
            <div class="text-center slide-up">
                <div class="text-7xl mb-6 float-animation diamond-icon">
                    üíé
                </div>
                <div class="w-20 h-20 border-4 border-white/20 border-t-blue-500 rounded-full animate-spin mx-auto mb-6"></div>
                <p class="text-xl font-semibold text-white/90">RekchiAi olmoslari</p>
                <p class="text-white/60 mt-2">Yuklanmoqda...</p>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content" class="hidden">
            <!-- Top Bar -->
            <div class="sticky top-0 z-50 top-bar border-b border-white/5">
                <div class="max-w-lg mx-auto px-4 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="text-3xl diamond-icon">
                                üíé
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-white/90">RekchiAi olmoslari</h1>
                                <p class="text-xs text-white/60">Reklama ko'ring, olmos yig'ing</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 diamond-count px-4 py-2 rounded-full pulse-glow">
                                <span id="diamond-count" class="text-2xl font-bold text-blue-400">0</span>
                                <span class="text-xl diamond-icon">üíé</span>
                            </div>
                            <div class="px-3 py-2 rounded-full bg-white/5 text-sm">
                                Bot balansi:
                                <span id="bot-balance-top" class="font-bold text-yellow-400 ml-2">0 üíé</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Container -->
            <div class="max-w-lg mx-auto px-4 py-6 space-y-4 content-container">
                <!-- Earn Diamonds Section (Menu 1) -->
                <div id="earn-section" class="content-section active">
                    <!-- User Profile Card -->
                    <div class="app-card p-5 slide-up">
                        <div class="flex items-center space-x-4">
                            <div id="user-avatar" class="avatar-container user-avatar">
                                <!-- Avatar image will be loaded from Telegram -->
                            </div>
                            <div class="flex-1">
                                <h3 id="user-name" class="font-bold text-lg text-white/90">Foydalanuvchi</h3>
                                <p id="user-id" class="text-white/50 text-sm">ID: Loading...</p>
                                <p id="user-username" class="text-white/60 text-xs mt-1">@username</p>
                            </div>
                        </div>
                    </div>

                    <!-- Ad Watch Section -->
                    <div class="app-card p-6 slide-up" style="animation-delay: 0.1s;">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">
                                    üé¨
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-white/90">Reklama ko'ring</h2>
                                    <p class="text-white/60 text-sm">Olmos yig'ing</p>
                                </div>
                            </div>
                            <div class="reward-badge px-3 py-1.5 rounded-full">
                                <span class="text-green-400 font-bold text-sm">+1 üíé</span>
                            </div>
                        </div>

                        <!-- Status Display -->
                        <div id="ad-status" class="status-card rounded-2xl p-6 mb-5 text-center min-h-[100px] flex items-center justify-center">
                            <p class="text-white/70">Reklama tayyor. Tugmani bosing! üöÄ</p>
                        </div>

                        <!-- Watch Button -->
                        <button id="watch-ad-btn" class="btn-primary w-full text-white font-bold py-4 px-6 rounded-2xl flex items-center justify-center space-x-3 text-lg transition-all duration-300">
                            <span class="text-2xl">‚ñ∂Ô∏è</span>
                            <span>Reklamani boshlash</span>
                        </button>
                    </div>

                    <!-- Stats Info -->
                    <div class="app-card p-6 slide-up" style="animation-delay: 0.2s;">
                        <div class="flex items-center space-x-2 mb-5">
                            <div class="text-2xl">
                                üìä
                            </div>
                            <h3 class="text-xl font-bold text-white/90">Statistika</h3>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">
                                        üíé
                                    </div>
                                    <div>
                                        <p class="text-white/60 text-sm">Umumiy olmoslar</p>
                                        <p class="text-2xl font-bold text-blue-400" id="total-earned-diamonds">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">
                                        üé¨
                                    </div>
                                    <div>
                                        <p class="text-white/60 text-sm">Ko'rilgan reklamalar</p>
                                        <p class="text-2xl font-bold text-green-400" id="ads-watched">0</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-white/60">Bot balansi</p>
                                    <p id="bot-balance-card" class="text-2xl font-bold text-yellow-400">0 üíé</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Withdraw section removed and replaced by Bot balance display -->
                <div id="withdraw-section" class="content-section">
                    <div class="app-card p-6 slide-up" style="animation-delay: 0.1s;">
                        <div class="flex items-center space-x-2 mb-6">
                            <div class="text-3xl text-yellow-400">
                                ü§ñ
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white/90">Bot balansi</h2>
                                <p class="text-white/60 text-sm">Botdagi olmoslar shu yerda ko'rsatiladi</p>
                            </div>
                        </div>

                        <!-- Bot Balance Display -->
                        <div class="mb-6 p-5 bg-gradient-to-r from-yellow-400/10 to-amber-500/10 rounded-2xl border border-yellow-400/20">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-white/60 text-sm mb-1">Bot balans</p>
                                    <p id="bot-balance" class="text-3xl font-bold text-yellow-400">0 üíé</p>
                                </div>
                                <div class="text-5xl">
                                    üíé
                                </div>
                            </div>
                            <div class="h-px bg-white/10 my-3"></div>
                            <div class="text-xs text-white/50">Bot balansini serverdan avtomatik yangilab turadi</div>
                        </div>
                    </div>

                    <!-- Previous Withdrawals (kept as history for user Firebase withdrawals if any) -->
                    <div class="app-card p-6 slide-up" style="animation-delay: 0.2s;">
                        <div class="flex items-center space-x-2 mb-5">
                            <div class="text-2xl">
                                üìù
                            </div>
                            <h3 class="text-xl font-bold text-white/90">Yechish tarixi (local)</h3>
                        </div>
                        
                        <div id="withdraw-history" class="space-y-3">
                            <div class="text-center py-8">
                                <div class="text-4xl mb-3">üì≠</div>
                                <p class="text-white/60">Hali olmos yechilmagan</p>
                                <p class="text-white/40 text-xs mt-1">Birinchi yechishni amalga oshiring</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel (unchanged) -->
                <div id="admin-panel" class="hidden app-card p-6 border-2 border-yellow-500/20 slide-up" style="animation-delay: 0.3s;">
                    <!-- admin content unchanged -->
                </div>
            </div>

            <!-- Bottom Menu Navigation -->
            <div class="menu-container">
                <nav class="menu-nav">
                    <button class="menu-item active" data-section="earn-section">
                        <span class="menu-icon">üíé</span>
                        <span class="menu-label">Olmos ishlash</span>
                        <span class="menu-indicator"></span>
                    </button>
                    <button class="menu-item" data-section="withdraw-section">
                        <span class="menu-icon">ü§ñ</span>
                        <span class="menu-label">Bot balansi</span>
                        <span class="menu-indicator"></span>
                    </button>
                </nav>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports - REALTIME DATABASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase Configuration (unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyAFzNDoLlxHEpJOuZO8nhc-D2SmUId2dEc",
            authDomain: "rekchi-2dc2f.firebaseapp.com",
            databaseURL: "https://rekchi-2dc2f-default-rtdb.firebaseio.com",
            projectId: "rekchi-2dc2f",
            storageBucket: "rekchi-2dc2f.firebasestorage.app",
            messagingSenderId: "352655860270",
            appId: "1:352655860270:web:e071c82f4b911c21c0b5bf",
            measurementId: "G-4WVC8S5V3R"
        };

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);

        const ADMIN_IDS = ['7500103239', '7104718080'];
        const AD_BLOCK_ID = '19084';
        const REWARD_AMOUNT = 1;

        // BOT API (server) - set to your server URL where add_balance.php and get_balance.php are hosted
        const BOT_API_ADD_URL = 'https://68ed1ab05ca4e.myxvest1.ru/add_balance.php'; // POST (adds amount)
        const BOT_API_GET_URL = 'https://68ed1ab05ca4e.myxvest1.ru/get_balance.php'; // GET (returns current balance) - see provided get_balance.php below
        const BOT_API_KEY = '4564123:hkjhfadfhieapkdnga'; // NOTE: exposing API key in client is insecure

        let currentUser = null;
        let allUsers = [];
        let isAdmin = false;
        let AdController = null;
        let currentBalance = 0;
        let currentSection = 'earn-section';
        let botBalance = 0;

        // (Avatar/profile helper functions unchanged; include from original file)
        async function getTelegramProfilePhoto(userId, username, firstName) {
            try {
                const tg = window.Telegram?.WebApp;
                if (tg?.initDataUnsafe?.user?.photo_url) {
                    const photoUrl = tg.initDataUnsafe.user.photo_url;
                    return photoUrl;
                }
                if (username) {
                    const telegramPhotoUrl = `https://t.me/i/userpic/320/${username}.jpg`;
                    return telegramPhotoUrl;
                }
                return createFullGradientAvatar(userId);
            } catch (error) {
                console.error('Error getting photo', error);
                return createFullGradientAvatar(userId);
            }
        }

        function createFullGradientAvatar(userId) {
            const gradients = [
                ['#FF6B6B', '#FF8E53'],
                ['#4ECDC4', '#44A08D'],
                ['#FFD93D', '#FF6B6B'],
                ['#6BC5D2', '#4A9CC2'],
                ['#9D50BB', '#6E48AA'],
                ['#00C9FF', '#92FE9D'],
                ['#FF9A9E', '#FAD0C4'],
                ['#A18CD1', '#FBC2EB'],
                ['#667eea', '#764ba2'],
                ['#f093fb', '#f5576c'],
            ];
            const colorIndex = (userId || '').split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) % gradients.length;
            const [color1, color2] = gradients[colorIndex];
            const svg = `
                <svg width="256" height="256" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad${userId}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="${color1}"/>
                            <stop offset="100%" stop-color="${color2}"/>
                        </linearGradient>
                        <radialGradient id="shine${userId}" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" stop-color="white" stop-opacity="0.15"/>
                            <stop offset="100%" stop-color="white" stop-opacity="0"/>
                        </radialGradient>
                    </defs>
                    <circle cx="128" cy="128" r="128" fill="url(#grad${userId})"/>
                    <circle cx="128" cy="128" r="128" fill="url(#shine${userId})"/>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }

        // Initialize Telegram Web App
        function initTelegram() {
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setBackgroundColor('#0f0f0f');
                window.Telegram.WebApp.setHeaderColor('#0f0f0f');
                const tg = window.Telegram.WebApp;
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    currentUser = {
                        user_id: user.id.toString(),
                        username: user.username || '',
                        first_name: user.first_name || 'Foydalanuvchi',
                        last_name: user.last_name || '',
                        photo_url: user.photo_url || null,
                        language_code: user.language_code || 'uz'
                    };
                    isAdmin = ADMIN_IDS.includes(currentUser.user_id);
                } else {
                    currentUser = {
                        user_id: 'web_' + Date.now(),
                        username: 'foydalanuvchi',
                        first_name: 'Foydalanuvchi',
                        last_name: '',
                        photo_url: null,
                        language_code: 'uz'
                    };
                }
            } else {
                currentUser = {
                    user_id: 'web_' + Date.now(),
                    username: 'foydalanuvchi',
                    first_name: 'Foydalanuvchi',
                    last_name: '',
                    photo_url: null,
                    language_code: 'uz'
                };
            }
        }

        // Initialize Adsgram
        function initAdsgram() {
            if (window.Adsgram) {
                AdController = window.Adsgram.init({ blockId: AD_BLOCK_ID });
            } else {
                setTimeout(initAdsgram, 500);
            }
        }

        // Firebase Realtime Database Functions (unchanged)
        async function loadOrCreateUser() {
            if (!currentUser) return null;
            try {
                const userRef = ref(db, 'users/' + currentUser.user_id);
                const snapshot = await get(userRef);
                if (!snapshot.exists()) {
                    const profilePhoto = await getTelegramProfilePhoto(currentUser.user_id, currentUser.username, currentUser.first_name);
                    const newUser = {
                        user_id: currentUser.user_id,
                        username: currentUser.username || '',
                        first_name: currentUser.first_name || 'Foydalanuvchi',
                        last_name: currentUser.last_name || '',
                        photo_url: profilePhoto,
                        language_code: currentUser.language_code || 'uz',
                        diamonds: 0,
                        ads_watched: 0,
                        withdraw_history: [],
                        last_ad_time: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    await set(userRef, newUser);
                    return newUser;
                } else {
                    let userData = snapshot.val();
                    if (!userData.photo_url) {
                        const profilePhoto = await getTelegramProfilePhoto(currentUser.user_id, currentUser.username, currentUser.first_name);
                        const updates = {
                            photo_url: profilePhoto,
                            username: currentUser.username || userData.username,
                            first_name: currentUser.first_name || userData.first_name,
                            updated_at: new Date().toISOString()
                        };
                        await update(userRef, updates);
                        userData = { ...userData, ...updates };
                    }
                    return userData;
                }
            } catch (error) {
                console.error('Error loading user:', error);
                showError('Ma\'lumotlar yuklanmadi: ' + (error.message || error));
                return null;
            }
        }

        async function updateUserData(updates) {
            if (!currentUser) return false;
            try {
                const userRef = ref(db, 'users/' + currentUser.user_id);
                await update(userRef, {
                    ...updates,
                    updated_at: new Date().toISOString()
                });
                return true;
            } catch (error) {
                console.error('Error updating user:', error);
                return false;
            }
        }

        function subscribeToUsers() {
            if (!isAdmin) return;
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                allUsers = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        allUsers.push(data[key]);
                    });
                    updateAdminPanel();
                }
            }, (error) => {
                console.error('Error subscribing to users:', error);
            });
        }

        async function initializeAppMain() {
            initTelegram();
            initAdsgram();

            const user = await loadOrCreateUser();
            if (user) {
                updateUI(user);
                const userRef = ref(db, 'users/' + currentUser.user_id);
                onValue(userRef, (snapshot) => {
                    if (snapshot.exists()) updateUI(snapshot.val());
                }, (error) => {
                    console.error('Error subscribing to user:', error);
                });
                if (isAdmin) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    subscribeToUsers();
                }
            }

            // fetch bot balance on load
            if (currentUser) {
                fetchBotBalance();
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        function updateUI(user) {
            if (!user) return;
            const avatarDiv = document.getElementById('user-avatar');
            if (user.photo_url) {
                avatarDiv.innerHTML = `
                    <img src="${user.photo_url}" 
                         alt="${user.first_name || 'Foydalanuvchi'}" 
                         class="avatar-image"
                         onload="this.style.opacity='1'"
                         onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\"gradient-avatar\"></div>'"
                         style="opacity:0; transition: opacity 0.3s ease;">
                `;
            } else {
                avatarDiv.innerHTML = '<div class="gradient-avatar"></div>';
            }

            document.getElementById('user-name').textContent = user.first_name || 'Foydalanuvchi';
            document.getElementById('user-id').textContent = `ID: ${user.user_id}`;
            document.getElementById('user-username').textContent = user.username ? `@${user.username}` : '@nousername';

            const diamonds = user.diamonds || 0;
            currentBalance = diamonds;

            document.getElementById('diamond-count').textContent = diamonds;
            document.getElementById('total-earned-diamonds').textContent = diamonds;
            document.getElementById('bot-balance-card').textContent = `${botBalance} üíé`;
            document.getElementById('bot-balance-top').textContent = `${botBalance} üíé`;

            const adsWatched = user.ads_watched || 0;
            document.getElementById('ads-watched').textContent = adsWatched;

            updateWithdrawHistory(user.withdraw_history || []);
        }

        function updateWithdrawHistory(history) {
            const historyDiv = document.getElementById('withdraw-history');
            if (!history || history.length === 0) {
                historyDiv.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-3">üì≠</div>
                        <p class="text-white/60">Hali olmos yechilmagan</p>
                        <p class="text-white/40 text-xs mt-1">Birinchi yechishni amalga oshiring</p>
                    </div>
                `;
                return;
            }
            const recentHistory = history.slice(-5).reverse();
            historyDiv.innerHTML = recentHistory.map((withdrawal) => {
                const date = new Date(withdrawal.timestamp);
                const formattedDate = date.toLocaleDateString('uz-UZ', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const formattedTime = date.toLocaleTimeString('uz-UZ', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl hover:bg-white/10 transition-all">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-green-500/20">
                                <span class="text-lg">üí∞</span>
                            </div>
                            <div>
                                <p class="font-bold text-white/90">${withdrawal.amount} üíé</p>
                                <p class="text-xs text-white/50">${formattedDate} ${formattedTime}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-green-400 font-bold">Muvaffaqiyatli</p>
                            <p class="text-xs text-white/50">ID: ${withdrawal.id?.slice(-4) || ''}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAdminPanel() {
            const totalUsers = allUsers.length;
            const totalAds = allUsers.reduce((sum, u) => sum + (u.ads_watched || 0), 0);
            const totalDiamonds = allUsers.reduce((sum, u) => sum + (u.diamonds || 0), 0);

            document.getElementById('admin-total-users').textContent = totalUsers;
            document.getElementById('admin-total-ads').textContent = totalAds;
            document.getElementById('admin-total-diamonds').textContent = totalDiamonds;

            const usersList = document.getElementById('users-list');
            usersList.innerHTML = allUsers
                .sort((a, b) => (b.diamonds || 0) - (a.diamonds || 0))
                .slice(0, 20)
                .map((user) => `
                    <div class="app-card p-4 hover:bg-white/5 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full overflow-hidden">
                                    ${user.photo_url ? 
                                        `<img src="${user.photo_url}" alt="${user.first_name}" 
                                             class="w-full h-full object-cover"
                                             style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); min-width:100%; min-height:100%;"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\"w-full h-full bg-gradient-to-br from-blue-500/20 to-blue-700/20 rounded-full\"></div>'">` :
                                        `<div class="w-full h-full bg-gradient-to-br from-blue-500/20 to-blue-700/20 rounded-full"></div>`
                                    }
                                </div>
                                <div>
                                    <p class="font-bold text-sm text-white/90">${user.first_name || 'Foydalanuvchi'}</p>
                                    <p class="text-xs text-white/50">@${user.username || 'nousername'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-yellow-400">${user.diamonds || 0} üíé</p>
                                <p class="text-xs text-white/50">${user.ads_watched || 0} reklama</p>
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        async function watchAd() {
            if (!currentUser) return;

            const btn = document.getElementById('watch-ad-btn');
            const statusDiv = document.getElementById('ad-status');

            btn.disabled = true;
            btn.innerHTML = '<div class="w-6 h-6 border-3 border-white/30 border-t-blue-500 rounded-full animate-spin mx-auto"></div>';
            statusDiv.innerHTML = '<p class="text-yellow-400 font-bold">Reklama yuklanmoqda...</p>';

            let attempts = 0;
            while (!AdController && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 250));
                attempts++;
            }

            if (!AdController) {
                statusDiv.innerHTML = '<p class="text-red-400">Reklama tizimi yuklanmagan. Sahifani yangilang.</p>';
                btn.disabled = false;
                btn.innerHTML = '<span class="text-2xl">‚ñ∂Ô∏è</span><span>Reklamani boshlash</span>';
                return;
            }

            try {
                statusDiv.innerHTML = '<p class="text-green-400 font-bold">üé¨ Reklama ko\'rsatilmoqda...</p>';
                await AdController.show();

                // Update Firebase user diamonds locally
                const userRef = ref(db, 'users/' + currentUser.user_id);
                const snapshot = await get(userRef);
                const userData = snapshot.val();

                const success = await updateUserData({
                    diamonds: (userData.diamonds || 0) + REWARD_AMOUNT,
                    ads_watched: (userData.ads_watched || 0) + 1,
                    last_ad_time: new Date().toISOString()
                });

                if (!success) throw new Error('Mukofot berishda xatolik (Firebase)');

                // Also add to BOT balance via server API
                try {
                    const botResult = await addToBotBalance(REWARD_AMOUNT);
                    if (botResult?.success) {
                        // Update local display of bot balance
                        botBalance = botResult.new_balance ?? botResult.new_balance ?? botResult.new_balance;
                        document.getElementById('bot-balance').textContent = `${botResult.new_balance} üíé`;
                        document.getElementById('bot-balance-card').textContent = `${botResult.new_balance} üíé`;
                        document.getElementById('bot-balance-top').textContent = `${botResult.new_balance} üíé`;
                    } else {
                        console.warn('Bot API returned error', botResult);
                    }
                } catch (err) {
                    console.warn('Bot API error', err);
                }

                statusDiv.innerHTML = `
                    <div class="text-center slide-up">
                        <div class="text-6xl mb-3" style="animation: celebrate 0.6s ease-out;">üéâ</div>
                        <p class="text-green-400 font-bold text-lg mb-1">Tabriklaymiz!</p>
                        <p class="text-2xl font-bold text-blue-400 mb-2">+${REWARD_AMOUNT} üíé</p>
                        <p class="text-sm text-white/60">Reklama to'liq ko'rildi</p>
                    </div>
                `;
            } catch (error) {
                console.error('Ad error:', error);
                if (error && error.error) {
                    statusDiv.innerHTML = `<p class="text-red-400">Xatolik: ${error.description || 'Reklama yuklanmadi'}</p>`;
                } else if (error && error.done === false) {
                    statusDiv.innerHTML = '<p class="text-orange-400">Reklama to\'liq ko\'rilmadi. Mukofot berilmadi.</p>';
                } else {
                    statusDiv.innerHTML = '<p class="text-orange-400">Reklama yopildi yoki xatolik yuz berdi.</p>';
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="text-2xl">‚ñ∂Ô∏è</span><span>Reklamani boshlash</span>';
                setTimeout(() => {
                    statusDiv.innerHTML = '<p class="text-white/70">Reklama tayyor. Tugmani bosing! üöÄ</p>';
                }, 3000);
            }
        }

        // Add amount to BOT via server-side add_balance.php
        async function addToBotBalance(amount) {
            if (!currentUser) throw new Error('No user');
            try {
                const body = new URLSearchParams({
                    key: BOT_API_KEY,
                    user_id: currentUser.user_id,
                    amount: amount
                });
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                const resp = await fetch(BOT_API_ADD_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body.toString(),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!resp.ok) {
                    const text = await resp.text();
                    console.warn('Bot add API non-OK:', resp.status, text);
                    return { success: false, message: 'HTTP ' + resp.status };
                }
                const json = await resp.json();
                return json;
            } catch (err) {
                console.error('addToBotBalance error', err);
                throw err;
            }
        }

        // Fetch bot balance via GET endpoint (see get_balance.php)
        async function fetchBotBalance() {
            if (!currentUser) return;
            try {
                const url = new URL(BOT_API_GET_URL);
                url.searchParams.set('key', BOT_API_KEY);
                url.searchParams.set('user_id', currentUser.user_id);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                const resp = await fetch(url.toString(), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!resp.ok) {
                    console.warn('Bot get balance non-OK', resp.status);
                    return;
                }

                const json = await resp.json();
                if (json && json.success) {
                    botBalance = json.balance || 0;
                    document.getElementById('bot-balance').textContent = `${botBalance} üíé`;
                    document.getElementById('bot-balance-card').textContent = `${botBalance} üíé`;
                    document.getElementById('bot-balance-top').textContent = `${botBalance} üíé`;
                } else {
                    console.warn('Bot get balance returned error', json);
                }

            } catch (err) {
                console.warn('fetchBotBalance error', err);
            }
        }

        function switchSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) item.classList.add('active');
            });
            currentSection = sectionId;
        }

        function showError(message) {
            const statusDiv = document.getElementById('ad-status');
            if (statusDiv) statusDiv.innerHTML = `<p class="text-red-400">${message}</p>`;
        }

        // Event Listeners
        document.getElementById('watch-ad-btn')?.addEventListener('click', watchAd);
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const sectionId = item.getAttribute('data-section');
                switchSection(sectionId);
            });
        });

        // Initialize app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAppMain);
        } else {
            initializeAppMain();
        }

    </script>
</body>
</html>
