<!doctype html>
<html lang="uz" class="h-full dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RekchiAi Olmoslari</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- AdSonar kutubxonasi -->
    <script src="https://static.sonartech.io/lib/1.0.0/sonar.js?appId=app_c5fa4840"></script>
    
    <script> window.process = { env: { NODE_ENV: 'production' } }; </script>
    <style>
        body { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif; background: #0f0f0f; color: #fff; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        @keyframes pulse-glow { 0%,100%{box-shadow:0 0 20px rgba(0,150,255,.3),0 0 40px rgba(0,150,255,.1)} 50%{box-shadow:0 0 30px rgba(0,150,255,.5),0 0 60px rgba(0,150,255,.2)} }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
        .float-animation{animation:float 3s ease-in-out infinite} 
        .pulse-glow{animation:pulse-glow 2s ease-in-out infinite} 
        .slide-up{animation:slideUp .4s ease-out}

        /* UI Elements */
        .app-card{background:linear-gradient(135deg, rgba(20,20,20,.95), rgba(30,30,30,.95)); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.08); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.5);}
        .gradient-bg{background:linear-gradient(135deg,#0f0f0f 0%,#1a1a1a 50%,#2d2d2d 100%)}
        .diamond-icon{filter:drop-shadow(0 0 8px rgba(0,150,255,.6)); color:#0096ff}
        
        .btn-primary{background:linear-gradient(135deg,#0096ff 0%,#0066cc 100%); box-shadow:0 6px 20px rgba(0,150,255,.3); transition:all .3s;}
        .btn-primary:active{transform:scale(0.98);}
        .btn-primary:disabled{opacity:0.7; cursor:not-allowed;}

        .avatar-container{ width:64px; height:64px; border-radius:50%; overflow:hidden; position:relative; background:linear-gradient(135deg,#0096ff,#0066cc); flex:0 0 auto; }
        .gradient-avatar{ width:100%; height:100%; background:linear-gradient(135deg,#0096ff,#0066cc); }
        .avatar-image { width: 100%; height: 100%; object-fit: cover; }

        .menu-container{ position:fixed; bottom:0; left:0; right:0; background:rgba(15,15,15,.95); backdrop-filter:blur(20px); border-top:1px solid rgba(255,255,255,.1); z-index:100; padding-bottom:env(safe-area-inset-bottom); }
        .menu-nav{ display:flex; max-width:600px; margin:0 auto; padding:12px 16px; gap:8px; }
        .menu-item{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:12px 8px; border-radius:16px; background:transparent; border:none; color:rgba(255,255,255,.5); transition:all .3s; }
        .menu-item.active{ background:rgba(255,255,255,.1); color:white; }
        
        .content-section{ display:none; animation:fadeIn .3s ease-out; } .content-section.active{ display:block; }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

        /* Leaderboard */
        .leaderboard-item { display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:rgba(255,255,255,0.03); margin-bottom:8px; }
        .leader-rank { width:30px; font-weight:bold; color:#ffd54a; text-align:center; }
        .leader-avatar { width:40px; height:40px; border-radius:50%; overflow:hidden; }
        .leader-info { flex:1; }
        .leader-name { font-weight:600; font-size:14px; }
        .leader-score { font-weight:bold; color:#0096ff; }

        /* Reward Notification */
        .reward-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #22c55e; color: white; padding: 12px 24px; border-radius: 50px; font-weight: bold; z-index: 9999; display: none; box-shadow: 0 10px 20px rgba(34,197,94,0.3); }
        .reward-notification.active { display: block; animation: slideUp 0.3s forwards; }
    </style>
</head>
<body class="h-full gradient-bg text-white overflow-auto pb-24">
    
    <!-- Notification -->
    <div id="reward-notification" class="reward-notification">
        +1 Olmos qo'shildi! üíé
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f0f0f]">
        <div class="text-center">
            <div class="text-7xl mb-6 float-animation diamond-icon">üíé</div>
            <div class="w-12 h-12 border-4 border-white/20 border-t-blue-500 rounded-full animate-spin mx-auto"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="hidden min-h-full w-full">
        <!-- Top Bar -->
        <div class="sticky top-0 z-40 border-b border-white/5 bg-[#0f0f0f]/80 backdrop-blur-md">
            <div class="max-w-lg mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="text-2xl diamond-icon">üíé</div>
                    <h1 class="font-bold text-lg">RekchiAi</h1>
                </div>
                <div class="flex items-center space-x-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/10">
                    <span id="diamond-count" class="text-xl font-bold text-yellow-400">0</span>
                    <span class="text-lg">üíé</span>
                </div>
            </div>
        </div>

        <div class="max-w-lg mx-auto px-4 py-6 space-y-4">
            
            <!-- EARN SECTION -->
            <div id="earn-section" class="content-section active space-y-4">
                <!-- User Profile Card -->
                <div class="app-card p-5 flex items-center space-x-4">
                    <div id="user-avatar" class="avatar-container"></div>
                    <div>
                        <h3 id="user-name" class="font-bold text-lg">Loading...</h3>
                        <p id="user-id" class="text-white/50 text-xs">ID: ...</p>
                    </div>
                </div>

                <!-- Ad Watch Card -->
                <div class="app-card p-6 text-center">
                    <div class="text-5xl mb-4">üì∫</div>
                    <h2 class="text-xl font-bold mb-2">Reklama ko'ring</h2>
                    <p class="text-white/60 text-sm mb-6">Har bir to'liq ko'rilgan reklama uchun 1 olmos olasiz.</p>
                    
                    <div id="ad-status" class="mb-4 h-6 text-sm font-medium text-blue-400"></div>

                    <button id="watch-ad-btn" class="btn-primary w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2">
                        <span>‚ñ∂Ô∏è</span> Reklamani boshlash
                    </button>
                </div>
            </div>

            <!-- LEADERBOARD SECTION -->
            <div id="leaderboard-section" class="content-section">
                <div class="app-card p-5">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span>üèÜ</span> Top Reyting
                    </h2>
                    <div id="leaderboard-list" class="space-y-2">
                        <div class="text-center text-white/50 py-4">Yuklanmoqda...</div>
                    </div>
                </div>
            </div>

            <!-- ADMIN SECTION (Hidden by default) -->
            <div id="admin-section" class="content-section hidden">
                <div class="app-card p-5 border border-yellow-500/30">
                    <h2 class="text-xl font-bold mb-4 text-yellow-400">üëë Admin Panel</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                        <div class="bg-white/5 p-3 rounded-lg">
                            <div class="text-2xl font-bold" id="admin-users-count">0</div>
                            <div class="text-xs text-white/50">Foydalanuvchilar</div>
                        </div>
                        <div class="bg-white/5 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-blue-400" id="admin-diamonds-count">0</div>
                            <div class="text-xs text-white/50">Jami Olmoslar</div>
                        </div>
                    </div>
                    <button id="admin-refresh-btn" class="w-full bg-white/10 py-2 rounded-lg mb-4">Yangilash</button>
                    <div class="max-h-64 overflow-y-auto space-y-2" id="admin-users-list">
                        <!-- User list here -->
                    </div>
                </div>
            </div>

        </div>

        <!-- Bottom Navigation -->
        <div class="menu-container">
            <nav class="menu-nav">
                <button class="menu-item active" onclick="switchTab('earn-section', this)">
                    <span class="text-xl">üíé</span>
                    <span class="text-xs mt-1">Ishlash</span>
                </button>
                <button class="menu-item" onclick="switchTab('leaderboard-section', this)">
                    <span class="text-xl">üèÜ</span>
                    <span class="text-xs mt-1">Reyting</span>
                </button>
            </nav>
        </div>
    </div>

    <script>
        // --- SOZLAMALAR ---
        const API_URL = 'https://68ed1ab05ca4e.myxvest1.ru/api.php'; // PHP fayl manzili
        const API_KEY = '4564123:hkjhfadfhieapkdnga';
        const ADSONAR_ID = "rekchiai";
        const ADMIN_IDS = ['7500103239', '7104718080'];

        let currentUser = null;
        let isWatchingAd = false;

        // --- TELEGRAM INIT ---
        function initTelegram() {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.ready();
                tg.expand();
                tg.setHeaderColor('#0f0f0f');
                tg.setBackgroundColor('#0f0f0f');

                const user = tg.initDataUnsafe?.user;
                if (user) {
                    currentUser = {
                        user_id: user.id.toString(),
                        username: user.username || '',
                        first_name: user.first_name || 'Foydalanuvchi',
                        photo_url: user.photo_url || null
                    };
                }
            }
            
            // Agar Telegramda ochilmasa (test uchun)
            if (!currentUser) {
                currentUser = {
                    user_id: 'test_' + Math.floor(Math.random() * 1000),
                    username: 'tester',
                    first_name: 'Test User',
                    photo_url: null
                };
            }
        }

        // --- BACKEND BILAN ALOQA (Fetch) ---
        async function apiRequest(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: API_KEY,
                        action: action,
                        user_id: currentUser.user_id,
                        ...data
                    })
                });
                return await response.json();
            } catch (error) {
                console.error("API Xatosi:", error);
                return { success: false, message: "Internet xatosi" };
            }
        }

        // --- ASOSIY LOGIKA ---
        
        // 1. Foydalanuvchini yuklash/yaratish
        async function loadUser() {
            const res = await apiRequest('login', {
                username: currentUser.username,
                first_name: currentUser.first_name,
                photo_url: currentUser.photo_url
            });

            if (res.success) {
                updateUI(res.user);
                // Agar Admin bo'lsa
                if (ADMIN_IDS.includes(currentUser.user_id)) {
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadAdminStats();
                }
            } else {
                alert("Xatolik: " + res.message);
            }
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        // 2. Olmos qo'shish (Reklama ko'rgandan keyin)
        async function claimReward() {
            const res = await apiRequest('add_diamond', { amount: 1 });
            if (res.success) {
                document.getElementById('diamond-count').textContent = res.new_balance;
                showNotification();
                document.getElementById('ad-status').textContent = "Muvaffaqiyatli! +1 Olmos";
                document.getElementById('ad-status').className = "mb-4 h-6 text-sm font-medium text-green-400";
            }
        }

        // 3. Reytingni yuklash
        async function loadLeaderboard() {
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '<div class="text-center text-white/50 py-4">Yuklanmoqda...</div>';

            const res = await apiRequest('get_leaderboard');
            
            if (res.success && res.leaderboard.length > 0) {
                listEl.innerHTML = res.leaderboard.map((u, i) => `
                    <div class="leaderboard-item">
                        <div class="leader-rank">${i + 1}</div>
                        <div class="leader-avatar">
                            ${u.photo_url ? `<img src="${u.photo_url}" class="w-full h-full object-cover">` : `<div class="gradient-avatar w-full h-full"></div>`}
                        </div>
                        <div class="leader-info">
                            <div class="leader-name">${escapeHtml(u.first_name)}</div>
                            <div class="text-xs text-white/40">@${u.username || '-'}</div>
                        </div>
                        <div class="leader-score">${u.diamonds} üíé</div>
                    </div>
                `).join('');
            } else {
                listEl.innerHTML = '<div class="text-center text-white/50">Hozircha bo\'sh</div>';
            }
        }

        // 4. Admin Statistikasi
        async function loadAdminStats() {
            const res = await apiRequest('admin_stats');
            if (res.success) {
                document.getElementById('admin-users-count').textContent = res.total_users;
                document.getElementById('admin-diamonds-count').textContent = res.total_diamonds;
                
                const usersList = document.getElementById('admin-users-list');
                usersList.innerHTML = res.users.map(u => `
                    <div class="flex justify-between items-center text-sm p-2 bg-white/5 rounded">
                        <span>${escapeHtml(u.first_name)}</span>
                        <span class="font-bold text-yellow-400">${u.diamonds} üíé</span>
                    </div>
                `).join('');
            }
        }

        // --- UI FUNKSIYALARI ---
        function updateUI(user) {
            document.getElementById('user-name').textContent = user.first_name || currentUser.first_name;
            document.getElementById('user-id').textContent = `ID: ${currentUser.user_id}`;
            document.getElementById('diamond-count').textContent = user.diamonds;

            const avatarEl = document.getElementById('user-avatar');
            const photo = user.photo_url || currentUser.photo_url;
            if (photo) {
                avatarEl.innerHTML = `<img src="${photo}" class="avatar-image">`;
            } else {
                avatarEl.innerHTML = `<div class="gradient-avatar"></div>`;
            }
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');

            if (tabId === 'leaderboard-section') {
                loadLeaderboard();
            }
        }

        function showNotification() {
            const notif = document.getElementById('reward-notification');
            notif.classList.add('active');
            setTimeout(() => notif.classList.remove('active'), 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }

        // --- REKLAMA LOGIKASI (AdSonar) ---
        document.getElementById('watch-ad-btn').addEventListener('click', function() {
            if (isWatchingAd) return;
            const btn = this;
            const statusEl = document.getElementById('ad-status');

            if (!window.Sonar) {
                alert("Reklama tizimi yuklanmadi. Internetni tekshiring.");
                return;
            }

            isWatchingAd = true;
            btn.disabled = true;
            btn.style.opacity = "0.5";
            statusEl.textContent = "Reklama yuklanmoqda...";
            statusEl.className = "mb-4 h-6 text-sm font-medium text-blue-400";

            window.Sonar.show({
                adUnit: ADSONAR_ID,
                onStart: () => { statusEl.textContent = "Reklama ko'rilmoqda..."; },
                onReward: () => {
                    claimReward(); // Backendga so'rov yuborish
                },
                onClose: () => {
                    isWatchingAd = false;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    if (statusEl.textContent !== "Muvaffaqiyatli! +1 Olmos") {
                        statusEl.textContent = "";
                    }
                },
                onError: (err) => {
                    console.error(err);
                    isWatchingAd = false;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    statusEl.textContent = "Reklama xatosi. Qayta urinib ko'ring.";
                    statusEl.className = "mb-4 h-6 text-sm font-medium text-red-400";
                }
            });
        });

        document.getElementById('admin-refresh-btn').addEventListener('click', loadAdminStats);

        // --- START ---
        initTelegram();
        loadUser();

    </script>
</body>
</html>
